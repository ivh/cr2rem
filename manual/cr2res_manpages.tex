\section{Recipe man-pages}\label{sec:manpages}
The following is auto-generated pages with the manual-pages
of each recipe. These can be viewed any time on the command-line
with
\begin{verbatim}
    esorex --man-page <recipe>
\end{verbatim}
where \texttt{<recipe>} stands for the recipe name.

\subsection{cr2res\_util\_splice}
\begin{verbatim}

NAME
  cr2res_util_splice -- Splicing utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_splice [cr2res_util_splice-options] sof

DESCRIPTION
  Splicin                                                                 
    Compute ...                                                           
                                                                          
    Inputs                                                                
      blaze.fits CAL_FLAT_EXTRACT_1D [1]               
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      extracted.fits UTIL_EXTRACT_1D [1]               
                                                                          
    Outputs                                                               
                                                                          
    Algorithm                                                             
                                                                          
    Library functions used:                                               
  

OPTIONS
  A single option is provided by this recipe.

  --detector            : Only reduce the specified detector. [0]

\end{verbatim}
\subsection{cr2res\_obs\_pol}
\begin{verbatim}

NAME
  cr2res_obs_pol -- Polarimetry Observation recipe

SYNOPSIS
  esorex [esorex-options] cr2res_obs_pol [cr2res_obs_pol-options] sof

DESCRIPTION
  Polarimetry Observation                                                 
    The input raw frames are separated in A and B nodding positions. A    
    and B frames are reduced separately. The frames are grouped by blocks 
    of 4 frames. Each block generates 8 extractions. For each order       
    found, 8 spectra are passed to the demodulation functions.            
    The results are stored in polarimetry tables (1 per group of 4        
    frames). The polarimetry tables are then merged together if there are 
    several group of 4 frames available.                                  
                                                                          
    Inputs                                                                
      raw.fits OBS_POLARIMETRY_OTHER [4 to 4n]             
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      master_flat.fits CAL_FLAT_MASTER [0 to 1]        
                                                                          
    Outputs                                                               
      cr2res_obs_pol_specA.fits OBS_POL_SPECA          
      cr2res_obs_pol_specB.fits OBS_POL_SPECB          
                                                                          
    Algorithm                                                             
      loop on detectors d:                                                
        cr2res_obs_pol_reduce()                                           
          -> pol_speca(d)                                                 
          -> pol_specb(d)                                                 
      Save pol_speca                                                      
      Save pol_specb                                                      
                                                                          
      cr2res_obs_pol_reduce():                                            
        Read the nodding positions of the raw frames                      
        Split the rawframes in A and B positions                          
        Call cr2res_obs_pol_reduce_one() successively on A and B          
          -> pol_speca                                                    
          -> pol_specb                                                    
                                                                          
      cr2res_obs_pol_reduce_one():                                        
        Read the DITs                                                     
        Read the decker positions                                         
        Load the image list                                               
        Apply the calibrations to the image list                          
        Load the trace_wave                                               
        For each group of 4 images g:                                     
          Compute 8 extracted tables (2 per image):                       
              1u, 1d, 2u, 2d, 3u, 3d, 4u, 4d                              
              where u/d are for up and down                               
                    1->4 is derived with cr2res_pol_sort_frames()         
                    The decker info is used to derive the 8 slit fractions
          Count norders the number of different orders in those 8 tables  
              [Note : 1 extracted table has 1 spectrum per order]         
          loop on orders o:                                               
            Get the 8 spectra/wl/error for this order from                
                  1u, 1d, 2u, 2d, 3u, 3d, 4u, 4d                          
            Call the cr2res_pol_demod_stokes()                            
              -> demod_stokes(o, g)                                       
            Call cr2res_pol_demod_null()                                  
              -> demod_null(o, g)                                         
            Call cr2res_pol_demod_intens()                                
              -> demod_intens(o, g)                                       
          Create pol_spec(g) from demod_stokes(g),                        
                                  demod_null(g),                          
                                  demod_intens(g)                         
        Merge pol_spec(g) into pol_spec                                   
                                                                          
    Library functions used                                                
      cr2res_io_find_TRACE_WAVE()                                         
      cr2res_io_find_BPM()                                                
      cr2res_obs_pol_reduce()                                             
      cr2res_nodding_read_positions()                                     
      cr2res_combine_nodding_split_frames()                               
      cr2res_obs_pol_reduce_one()                                         
      cr2res_io_read_dits()                                               
      cr2res_io_read_decker_positions()                                   
      cr2res_io_load_image_list_from_set()                                
      cr2res_calib_imagelist()                                            
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_pol_sort_frames()                                            
      cr2res_trace_slit_fraction_create()                                 
      cr2res_trace_new_slit_fraction()                                    
      cr2res_extract_traces()                                             
      cr2res_obs_pol_get_order_numbers()                                  
      cr2res_pol_demod_stokes()                                           
      cr2res_pol_demod_null()                                             
      cr2res_pol_demod_intens()                                           
      cr2res_pol_POL_SPEC_create()                                        
      cr2res_pol_spec_pol_merge()                                         
      cr2res_io_save_POL_SPEC()                                           
  

OPTIONS
  The following options are provided by this recipe.

  --subtract_nolight_rows  : Subtract the no-light rows. [FALSE]
  --extract_oversample  : factor by which to oversample the extraction. [5]
  --extract_swath_width : The swath width. [800]
  --extract_height      : Extraction height. [-1]
  --extract_smooth      : Smoothing along the slit. [2.0]
  --detector            : Only reduce the specified detector. [0]

\end{verbatim}
\subsection{cr2res\_obs\_2d}
\begin{verbatim}

NAME
  cr2res_obs_2d -- 2D Observation recipe

SYNOPSIS
  esorex [esorex-options] cr2res_obs_2d [cr2res_obs_2d-options] sof

DESCRIPTION
  2D Observation                                                          
    This recipe is meant for extended objects. In each trace, the pixels  
    are calibrated, and stored in the output table.                       
                                                                          
    Inputs                                                                
      raw.fits OBS_2D_OBJECT [1 to n]                       
           and OBS_2D_SKY [0 to n]                         
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      master_flat.fits CAL_FLAT_MASTER [0 to 1]        
                                                                          
    Outputs                                                               
      cr2res_obs_2d_extract.fits OBS_2D_EXTRACT        
                                                                          
    Algorithm                                                             
      loop on raw frames f:                                               
        loop on detectors d:                                              
          cr2res_obs_2d_reduce()                                          
            -> extract(d)                                                 
        Save extract                                                      
                                                                          
      cr2res_obs_2d_reduce()                                              
        Load the input image                                              
        Apply the calibrations to the image                               
        Load the trace wave table                                         
        Call cr2res_extract2d_traces()                                    
          -> extract                                                      
                                                                          
    Library Functions used                                                
      cr2res_io_find_TRACE_WAVE()                                         
      cr2res_io_find_BPM()                                                
      cr2res_obs_2d_reduce()                                              
      cr2res_obs_2d_check_inputs_validity()                               
      cr2res_pfits_get_dit()                                              
      cr2res_io_load_image()                                              
      cr2res_calib_image()                                                
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_extract2d_traces()                                           
      cr2res_io_save_EXTRACT_2D()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --subtract_nolight_rows  : Subtract the no-light rows. [FALSE]
  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]

\end{verbatim}
\subsection{cr2res\_util\_bpm\_split}
\begin{verbatim}

NAME
  cr2res_util_bpm_split -- BPM splitting utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_bpm_split [cr2res_util_bpm_split-options] sof

DESCRIPTION
  BPM splitting                                                           
    Each input BPM is splitted into several BPMs                          
                                                                          
    Inputs                                                                
     	raw.fits CAL_DARK_BPM [1 to n]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
            or UTIL_NORM_BPM                           
                                                                          
    Outputs                                                               
      <input_name>_splitted_<bpm_code>.fits UTIL_BPM_SPLIT
                                                                          
    Algorithm                                                             
      loop on input raw frames f:                                         
        loop on detectors d:                                              
          loop on bpm types t:                                            
            call cr2res_bpm_from_mask()                                   
             -> bpm_single_type(t, d, f)                                  
        loop on bpm types t:                                              
          Save bpm_single_type(f, t) (UTIL_BPM_SPLIT)                     
                                                                          
    Library functions used:                                               
      cr2res_io_load_BPM()                                                
      cr2res_bpm_from_mask()                                              
      cr2res_io_save_BPM()                                                
  

OPTIONS
  A single option is provided by this recipe.

  --detector            : Only reduce the specified detector. [0]

\end{verbatim}
\subsection{cr2res\_util\_extract}
\begin{verbatim}

NAME
  cr2res_util_extract -- Optimal Extraction utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_extract [cr2res_util_extract-options] sof

DESCRIPTION
  Spectrum Extraction                                                     
    This utility performs the optimal extraction along precomputed traces 
                                                                          
    Inputs                                                                
      raw.fits FLAT [1 to n]                               
            or UTIL_CALIB                              
            or WAVE_UNE                                    
            or WAVE_FPET                                   
            or CAL_NODDING_OTHER                           
            or CAL_NODDING_JITTER                           
            or OBS_NODDING_OTHER                            
            or OBS_NODDING_JITTER                           
            or OBS_ASTROMETRY_OTHER                         
            or OBS_ASTROMETRY_JITTER                        
            or OBS_STARING_OTHER                            
            or OBS_STARING_JITTER                           
            or OBS_POLARIMETRY_OTHER                        
            or OBS_2D_OBJECT                                
            or OBS_2D_SKY                                   
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      slitfunc.fits CAL_FLAT_SLIT_FUNC [0 to 1]        
                 or UTIL_SLIT_FUNC                     
                 or OBS_NODDING_SLITFUNCA              
                 or OBS_NODDING_SLITFUNCB              
                 or OBS_STARING_SLITFUNC               
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
                                                                          
    Outputs                                                               
      <input_name>_extr1D.fits UTIL_EXTRACT_1D         
      <input_name>_extrSlitFu.fits UTIL_SLIT_FUNC      
      <input_name>_extrModel.fits UTIL_SLIT_MODEL      
                                                                          
    Algorithm                                                             
      loop on raw frames f:                                               
        loop on detectors d:                                              
          Load the trace wave                                             
          Recompute a new trace wave with the specified slit fraction     
                   (--slit_frac) if needed                                
          Load the image to extract                                       
          Load the BPM and set them in the image                          
          Load the input slit_func if available                           
          Run the extraction cr2res_extract_traces(--method,--height,     
                   --swath_width,--oversample,--smooth_slit,--smooth_spec)
            -> creates SLIT_MODEL(f,d), SLIT_FUNC(f,d), EXTRACT_1D(f,d)   
        Save SLIT_MODEL(f), SLIT_FUNC(f), EXTRACT_1D(f)                   
                                                                          
    Library functions used                                                
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_trace_new_slit_fraction()                                    
      cr2res_io_load_image()                                              
      cr2res_io_load_BPM()                                                
      cr2res_extract_traces()                                             
      cr2res_io_save_SLIT_MODEL()                                         
      cr2res_io_save_SLIT_FUNC()                                          
      cr2res_io_save_EXTRACT_1D()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --oversample          : factor by which to oversample the extraction. [5]
  --swath_width         : The swath width. [800]
  --height              : Extraction height. [-1]
  --smooth_slit         : Smoothing along the slit at extraction. [2.0]
  --smooth_spec         : Smoothing spectrum at extraction. [0.0]
  --method              : Extraction method (SUM / MEDIAN / TILTSUM / OPT_VERT /
                          OPT_CURV ). [OPT_CURV]
  --slit_frac           : Wished slit fraction. [-1.0, -1.0]
  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]

\end{verbatim}
\subsection{cr2res\_util\_trace\_map}
\begin{verbatim}

NAME
  cr2res_util_trace_map -- TRACE_WAVE maps creation

SYNOPSIS
  esorex [esorex-options] cr2res_util_trace_map [cr2res_util_trace_map-options] sof

DESCRIPTION
  Maps creation                                                           
    Each input TRACE_WAVE file is converted into maps to visualize the    
    traces, wavelengths and the slit curvature                            
                                                                          
    Inputs                                                                
      raw.fits TW [1 to n]                             
                                                                          
    Outputs                                                               
      <input_name>_slit_curve.fits UTIL_TRACE_MAP_SLIT_CURVE
      <input_name>_wave.fits UTIL_TRACE_MAP_WL
      <input_name>_trace.fits UTIL_TRACE_MAP_TRACE
                                                                          
    Algorithm                                                             
      loop on input raw frames f:                                         
        loop on detectors d:                                              
          Load the trace_wave extension                                   
          Call cr2res_wave_gen_wave_map() to generate wave_map(d)         
          Call cr2res_trace_gen_image() to generate traces_map(d)         
          Call cr2res_slit_curv_gen_map() to generate slit_curv_map(d)    
      Save wave_map, traces_map and slit_curv_map                         
                                                                          
    Library Functions used                                                
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_trace_gen_image()                                            
      cr2res_slit_curv_gen_map()                                          
      cr2res_io_save_SLIT_CURV_MAP()                                      
      cr2res_io_save_WAVE_MAP()                                           
      cr2res_io_save_TRACE_MAP()                                          
  

OPTIONS
  The following options are provided by this recipe.

  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]

\end{verbatim}
\subsection{cr2res\_util\_genstd}
\begin{verbatim}

NAME
  cr2res_util_genstd -- Generate standard star FITS tables

SYNOPSIS
  esorex [esorex-options] cr2res_util_genstd [cr2res_util_genstd-options] sof

DESCRIPTION
  Photospheric flux table generation                                      
                                                                          
    This utility is used to generate the photospheric flux table          
                                                                          
    Inputs                                                                
      raw.txt PHOTO_FLUX_TXT [1 to n]                      
      The specified files are named after the standard star they represent
      (e.g. HIP61007.txt).                                                
      The first line of the file must contain the RA and DEC (hh mm ss).  
      (e.g. # 13 20 35.818        -36 42 44.26).                          
      The rest of the file must contain two columns:                      
      1st: Wavelengths in increasing order                                
      2nd: The atmospheric emission                                       
                                                                          
    Outputs                                                               
      cr2res_util_genstd.fits PHOTO_FLUX                
                                                                          
    Algorithm                                                             
                                                                          
    Library functions used                                                
  

OPTIONS
  A single option is provided by this recipe.

  --display             : Flag to plot. [FALSE]

\end{verbatim}
\subsection{cr2res\_util\_slit\_curv}
\begin{verbatim}

NAME
  cr2res_util_slit_curv -- Slit Curvature utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_slit_curv [cr2res_util_slit_curv-options] sof

DESCRIPTION
  Slit curvature computation                                              
    For each input trace_wave file, the slit curvature is derived from    
    each order that has at least 2 traces.                                
                                                                          
    Inputs                                                                
      trace.fits CAL_FLAT_TW [1 to n]                  
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      lamp.fits WAVE_FPET [1 to n]                         
                                                                          
    Outputs                                                               
      <input_lamp_name>_map.fits UTIL_SLIT_CURV_MAP     
      <input_lamp_name>_slit_curv.fits UTIL_SLIT_CURV  
      <input_lamp_name>_tw.fits UTIL_SLIT_CURV_TW       
                                                                          
                       TODO
    Algorithm                                                             
      loop on input raw files pairs (t,l):                                
        loop on detectors d:                                              
          Load the TRACE_WAVE table for the current detector              
          Loop over the traces t:                                         
            Call cr2res_slit_curv_compute_order_trace() to get the        
                  current trace curvatures                                
            Update the slit curvature in the TRACE_WAVE table             
          Generate a slit curve map                                       
        Save the TRACE_WAVE                                               
        Save the SLIT_CURVE_MAP                                           
                                                                          
    Library functions used                                                
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_slit_curv_compute_order_trace()                              
      cr2res_slit_curv_gen_map()                                          
      cr2res_io_save_SLIT_CURV_MAP()                                      
      cr2res_io_save_TRACE_WAVE()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]
  --display             : X value to display (1->2048). [0]

\end{verbatim}
\subsection{cr2res\_util\_trace}
\begin{verbatim}

NAME
  cr2res_util_trace -- Trace utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_trace [cr2res_util_trace-options] sof

DESCRIPTION
  Traces detection                                                        
    This utility detects the traces, fits polynomials on their edges      
    (Upper and Lower) and in their centers (All), and stores these        
    informations in the TRACE_WAVE file.                                  
    Each trace is uniquely identified by its Order/TraceNb values.        
    The Order values refer to the keywords indices (e.g. HIERARCH ESO INS 
    WLEN CENY4) in the product headers.                                   
    The TraceNb starts with 1, identifies traces within the same order.   
    The additional columns :                                              
      Wavelength                                             
      Wavelength_Error                                       
      SlitPolyA                                            
      SlitPolyB                                            
      SlitPolyC                                            
      SlitFraction                                          
    are filled with default values.                                       
                                                                          
    Inputs                                                                
      raw.fits FLAT [1 to n]                               
            or UTIL_CALIB                              
                                                                          
    Outputs                                                               
      <input_name>_tw.fits UTIL_TRACE_TW                
                                                                          
    Algorithm                                                             
      loop on input raw frames f:                                         
        loop on detectors d:                                              
          Use cr2res_trace(--degree, --min_cluster, --smooth, --opening)  
                  to measure the traces                                   
          if --split_traces, call cr2res_trace_split_traces() to split    
                 the traces                                               
          Use cr2res_trace_add_extra_columns() to add the additional      
                  columns (slit fraction, wl, slit curvature)             
        Save the trace wave table                                         
                                                                          
    Library functions used                                                
      cr2res_io_load_image()                                              
      cr2res_trace()                                                      
      cr2res_trace_add_extra_columns()                                    
      cr2res_trace_split_traces()                                         
      cr2res_io_save_TRACE_WAVE()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --degree              : polynomial degree for the fit to the orders. [2]
  --min_cluster         : size in pixels of the smallest allowed cluster.
                          [200000]
  --smooth_x            : Length of the smoothing kernel in x. [111]
  --smooth_y            : Length of the smoothing kernel in y. [401]
  --threshold           : Detection Threshold. [3.0]
  --opening             : Use a morphological opening to rejoin clusters. [TRUE]
  --split_traces        : Split the full slit traces. [0]
  --detector            : Only reduce the specified detector. [0]

\end{verbatim}
\subsection{cr2res\_util\_normflat}
\begin{verbatim}

NAME
  cr2res_util_normflat -- Flat Normalization utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_normflat [cr2res_util_normflat-options] sof

DESCRIPTION
  Flat normalization                                                      
    The input RAW files are grouped by setting/decker and each group is   
    reduced separately. For each group, a slit model file with matching   
    setting/decker is expected.                                           
                                                                          
    Inputs                                                                
      raw.fits FLAT [1 to n]                               
            or UTIL_CALIB                              
      slit_model.fits CAL_FLAT_SLIT_MODEL [1 to m]     
                   or UTIL_SLIT_MODEL                  
                   or OBS_NODDING_SLITMODELA           
                   or OBS_NODDING_SLITMODELB           
                                                                          
    Outputs                                                               
      cr2res_util_normflat_[setting]_[Decker]_bpm.fits UTIL_NORM_BPM
      cr2res_util_normflat_[setting]_[Decker]_master.fits UTIL_MASTER_FLAT
                                                                          
    Algorithm                                                             
      group the input frames by different settings                        
      loop on groups g:                                                   
        group the input frames by different decker positions              
        loop on decker positions p:                                       
          loop on detectors d:                                            
            cr2res_util_normflat_reduce() computes (master_flat,bpm)(g,p,d)
        Save master_flat(g,p)                                             
        Save bpm(g,p)                                                     
                                                                          
      cr2res_util_normflat_reduce()                                       
        Load the images list                                              
        Average the images to avg                                         
        Load the input slit_model with the proper setting/decker          
        Compute the master flat with cr2res_master_flat(avg,              
                 slit_model, --bpm_low, --bpm_high, --bpm_lines_ratio)    
          -> master_flat, bpm                                             
                                                                          
  Library functions used:                                                 
      cr2res_extract_frameset()                                           
      cr2res_io_extract_decker_frameset()                                 
      cr2res_io_find_SLIT_MODEL()                                         
      cr2res_io_load_image_list_from_set()                                
      cr2res_io_load_SLIT_MODEL()                                         
      cr2res_master_flat()                                                
      cr2res_io_save_MASTER_FLAT()                                        
      cr2res_io_save_BPM()                                                
  

OPTIONS
  The following options are provided by this recipe.

  --bpm_low             : Low threshold for BPM detection. [0.5]
  --bpm_high            : High threshold for BPM detection. [2.0]
  --bpm_lines_ratio     : Maximum ratio of bad pixels per line. [0.5]
  --detector            : Only reduce the specified detector. [0]

\end{verbatim}
\subsection{cr2res\_util\_plot}
\begin{verbatim}

NAME
  cr2res_util_plot -- Plotting utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_plot [cr2res_util_plot-options] sof

DESCRIPTION
  Plotting                                                                
    This utility detects the type of the first passed file, and plots     
    relevant graphs accordingly.                                          
                                                                          
    Inputs                                                                
      first.fits CATALOG [1]                           
              or EXTRACT_1D                            
      second.fits CATALOG [0 to 1]                     
    Outputs                                                               
      -                                                                   
                                                                          
    Algorithm                                                             
                                                                          
    Library Functions used                                                
  

OPTIONS
  The following options are provided by this recipe.

  --xmin                : Minimum x value to plot. [-1.0]
  --xmax                : Maximum x value to plot. [-1.0]
  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]
  --adjust_level        : Flag to adjust the level with 2 plots. [TRUE]

\end{verbatim}
\subsection{cr2res\_obs\_staring}
\begin{verbatim}

NAME
  cr2res_obs_staring -- Staring Observation recipe

SYNOPSIS
  esorex [esorex-options] cr2res_obs_staring [cr2res_obs_staring-options] sof

DESCRIPTION
  Staring Observation                                                     
    This recipe handles staring observations.                             
                                                                          
    Inputs                                                                
      raw.fits OBS_STARING_OTHER [1 to n]                   
            or OBS_STARING_JITTER [1 to n]                  
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      master_flat.fits CAL_FLAT_MASTER [0 to 1]        
                                                                          
    Outputs                                                               
  	cr2res_obs_staring_slitfunc.fits OBS_STARING_SLITFUNC
  	cr2res_obs_staring_model.fits OBS_STARING_SLITMODEL
  	cr2res_obs_staring_extracted.fits OBS_STARING_EXTRACT
                                                                          
    Algorithm                                                             
      loop on detectors d:                                                
        call cr2res_obs_staring_reduce()                                  
          -> extract(d)                                                   
          -> slitfunc(d)                                                  
          -> model(d)                                                     
      Save extract                                                        
      Save slitfunc                                                       
      Save model                                                          
                                                                          
      cr2res_obs_staring_reduce()                                         
        Load the input raw frames in an image list                        
        Apply the calibrations to the image list                          
        Collapse the image list                                           
        Load the input trace wave                                         
        Extract the spectra from the collapsed image                      
          -> extracted                                                    
          -> slit_func                                                    
          -> model_master                                                 
        Compute QC parameters                                             
                                                                          
    Library functions used                                                
      cr2res_io_find_TRACE_WAVE()                                         
      cr2res_io_find_BPM()                                                
      cr2res_obs_staring_reduce()                                         
      cr2res_io_read_dits()                                               
      cr2res_io_load_image_list_from_set()                                
      cr2res_calib_imagelist()                                            
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_extract_traces()                                             
      cr2res_io_save_COMBINED()                                           
      cr2res_io_save_EXTRACT_1D()                                         
      cr2res_io_save_SLIT_FUNC()                                          
  

OPTIONS
  The following options are provided by this recipe.

  --subtract_nolight_rows  : Subtract the no-light rows. [FALSE]
  --extract_oversample  : factor by which to oversample the extraction. [5]
  --extract_swath_width : The swath width. [800]
  --extract_height      : Extraction height. [-1]
  --extract_smooth      : Smoothing along the slit (1 for high S/N, 5 for low).
                          [2.0]
  --detector            : Only reduce the specified detector. [0]
  --display_order       : Apply the display for the specified order. [0]
  --display_trace       : Apply the display for the specified trace. [0]

\end{verbatim}
\subsection{cr2res\_cal\_wave}
\begin{verbatim}

NAME
  cr2res_cal_wave -- Wavelength Calibration

SYNOPSIS
  esorex [esorex-options] cr2res_cal_wave [cr2res_cal_wave-options] sof

DESCRIPTION
  Spectrum Extraction and Wavelength Calibration                          
    This recipe performs the extraction of the various orders along       
    the provided traces, and the wavelength calibration of these          
    extracted spectra.                                                    
    It can support different methods (--wl_method parameter):             
      XCORR:  Cross Correlation with a emission lines catalog (default)   
      LINE1D: Line identification and fitting for each 1D spectra         
      LINE2D: Line identification and fitting for all 1D spectra at once  
                                                                          
    Inputs                                                                
      raw.fits WAVE_UNE [1 to n]                           
            or WAVE_FPET [0 to n]                          
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      master_flat.fits CAL_FLAT_MASTER [0 to 1]        
      lines.fits EMISSION_LINES [0 to 1]               
                                                                          
    Outputs                                                               
      cr2res_cal_wave_tw.fits CAL_WAVE_TW               
      cr2res_cal_wave_wave_map.fits CAL_WAVE_MAP        
      cr2res_cal_wave_lines_diagnostics.fits CAL_WAVE_LINES_DIAGNOSTICS
      cr2res_cal_wave_extracted.fits CAL_WAVE_EXTRACT_1D
                                                                          
    Algorithm                                                             
      loop on detectors d:                                                
        Call cr2res_cal_wave_reduce()                                     
          -> out_trace_wave[une|fpet](d)                                  
          -> lines_diagnostics[une|fpet](d)                               
          -> out_extracted[une|fpet](d)                                   
          -> out_wave_map[une|fpet](d)                                    
      Save out_trace_wave[une|fpet]                                       
      Save lines_diagnostics[une|fpet]                                    
      Save out_extracted[une|fpet]                                        
      Save out_wave_map[une|fpet]                                         
                                                                          
      cr2res_cal_wave_reduce():                                           
        Successively for UNE and FPET RAW frames:                         
          Load the raw image list                                         
          Apply the calibrations to the image list                        
          Collapse the image list                                         
          Extract along the traces from the collapsed image               
          Compute the Wavelength with cr2res_wave_apply()                 
           -> out_trace_wave                                              
           -> lines_diagnostics                                           
           -> out_extracted                                               
          Compute the Wavelength map                                      
           -> out_wave_map                                                
                                                                          
      cr2res_wave_apply()                                                 
        loop on the traces t:                                             
          Get the spectrum                                                
          Get the Initial guess                                           
          Switch on the required method:                                  
            CR2RES_LINE2D: cr2res_wave_2d()                               
            CR2RES_LINE1D: cr2res_wave_line_fitting()                     
            CR2RES_ETALON: cr2res_wave_etalon()                           
            CR2RES_XCORR:  cr2res_wave_xcorr()                            
                                                                          
    Library Functions used                                                
      cr2res_io_find_TRACE_WAVE()                                         
      cr2res_io_find_BPM()                                                
      cr2res_io_read_dits()                                               
      cr2res_io_load_image_list_from_set()                                
      cr2res_calib_imagelist()                                            
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_extract_traces()                                             
      cr2res_wave_apply()                                                 
      cr2res_extract_EXTRACT1D_get_spectrum()                             
      cr2res_wave_estimate_compute()                                      
      cr2res_wave_2d()                                                    
      cr2res_wave_line_fitting()                                          
      cr2res_wave_etalon()                                                
      cr2res_wave_xcorr()                                                 
      cr2res_wave_gen_wave_map()                                          
      cr2res_io_save_TRACE_WAVE()                                         
      cr2res_io_save_WAVE_MAP()                                           
      cr2res_io_save_LINES_DIAGNOSTICS()                                  
      cr2res_io_save_EXTRACT_1D()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]
  --keep                : Subtract the no-light rows. [FALSE]
  --collapse_method     : Collapse the input images (MEAN or MEDIAN). [MEDIAN]
  --ext_oversample      : factor by which to oversample the extraction. [5]
  --ext_swath_width     : The swath width. [800]
  --ext_height          : Extraction height. [120]
  --ext_smooth_slit     : Smoothing along the slit. [3.0]
  --wl_method           : Wavelength Method (XCORR / LINE1D / LINE2D). [XCORR]
  --wl_shift            : Wavelength shift (nm) to apply to the guess. [0.0]
  --wl_est              : Estimated wavelength start and end. [-1.0, -1.0]
  --wl_err              : Estimated wavelength error (in nm). [-1.0]
  --wl_degree           : Wavelegth Polynomial degree. [2]
  --log                 : Flag for taking the Log() value of the lines. [FALSE]
  --fallback            : Flag for using the input WL when no computation.
                          [FALSE]
  --keep                : Flag for re-using higher degrees of first guess in
                          Cross-Corr. [FALSE]
  --clean_spectrum      : Flag to automatically clean the missing lines. [TRUE]
  --display             : Flag for display. [FALSE]
  --display_range       : Wavelength range to display [start, end] (in nm).
                          [-1.0, -1.0]

\end{verbatim}
\subsection{cr2res\_util\_genlines}
\begin{verbatim}

NAME
  cr2res_util_genlines -- Generate spectrum calibration FITS tables

SYNOPSIS
  esorex [esorex-options] cr2res_util_genlines [cr2res_util_genlines-options] sof

DESCRIPTION
   Generate Lines calibration tables                                       
                                                                          
    Inputs                                                                
      raw1.txt EMISSION_LINES_TXT [1]                       
      raw2.txt LINES_SELECTION_TXT [0 to 1]                 
      The ASCII file raw1.txt must contain two columns:                   
        1st: Wavelengths in increasing order (the unit is corrected by    
                 the factor option to obtain nanometers).                 
        2nd: The atmospheric emission.                                    
        The file is in the catalogs/ directory of the CR2RES distribution.
      The optional ASCII files raw2.txt contain a list of wavelength      
        ranges (1 per line) of type: 1632.25,1632.70                      
        The files are in the catalogs/selection/ directory of the CR2RES  
            distribution. They are called XXX.dat, where XXX              
            identifies the setting [L3244, L3340, ...].                   
                                                                          
    Output                                                                
      cr2res_util_genlines.fits EMISSION_LINES           
      cr2res_util_genlines_XXX.fits EMISSION_LINES       
                                                                          
    Algorithm                                                             
      Parse and load the 2 columns raw1.txt file                          
      Apply the --wl_factor correction                                    
      if (--display) plot it                                              
      Create the CPL table                                                
      Save the table with all lines                                       
      Loop on the selection files                                         
          Only keep the lines that fall in the selection ranges (if any)  
          Save the table with the selected lines                          
                                                                          
    Library functions used                                                
      cr2res_io_save_EMISSION_LINES()                                     
  

OPTIONS
  The following options are provided by this recipe.

  --wl_factor           : The factor used to multiply the wl. [1.0]
  --display             : Flag to plot. [FALSE]

\end{verbatim}
\subsection{cr2res\_util\_calib}
\begin{verbatim}

NAME
  cr2res_util_calib -- Calibration utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_calib [cr2res_util_calib-options] sof

DESCRIPTION
  Frames Calibration                                                      
    Each input file is corrected with BPM / Dark / Flat / Det.Lin. / Cosmics
                                                                          
    Inputs                                                                
      raw.fits FLAT [1 to n]                                
            or WAVE_UNE                                     
            or WAVE_FPET                                    
            or CAL_NODDING_OTHER                           
            or CAL_NODDING_JITTER                           
            or OBS_NODDING_OTHER                            
            or OBS_NODDING_JITTER                           
            or OBS_ASTROMETRY_OTHER                         
            or OBS_ASTROMETRY_JITTER                        
            or OBS_STARING_OTHER                            
            or OBS_STARING_JITTER                           
            or OBS_POLARIMETRY_OTHER                        
            or OBS_2D_OBJECT                                
            or OBS_2D_SKY                                   
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      master_flat.fits CAL_FLAT_MASTER [0 to 1]        
                                                                          
    Outputs                                                               
      <input_name>_calibrated.fits UTIL_CALIB          
      or                                                                  
      <input_name>_calibrated_collapsed.fits UTIL_CALIB
                                                                          
    Algorithm                                                             
      loop on detectors d:                                                
        Call cr2res_calib_imagelist()() to calibrate --calib_cosmics_corr,
                 detlin, bpm, dark, flat                                  
          -> calibrated(d)                                                
        Collapse the calibrated image list to collapsed(d)                
        if (collapse) save collapsed                                      
        else save every individual calibrated frame                       
    Library functions used:                                               
      cr2res_io_load_image()                                              
      cr2res_calib_imagelist()                                            
      cr2res_io_save_CALIBRATED()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --detector            : Only reduce the specified detector. [0]
  --clean_bad           : Apply the cleaning to the bad pixels. [FALSE]
  --subtract_nolight_rows  : Subtract the no-light rows. [FALSE]
  --calib_cosmics_corr  : Correct the Cosmics. [FALSE]
  --collapse            : Collapse the input (NONE, SUM, MEAN or MEDIAN). [NONE]

\end{verbatim}
\subsection{cr2res\_cal\_detlin}
\begin{verbatim}

NAME
  cr2res_cal_detlin -- Detector Linearity recipe

SYNOPSIS
  esorex [esorex-options] cr2res_cal_detlin [cr2res_cal_detlin-options] sof

DESCRIPTION
  Detector Linearity                                                      
    Measure the pixels non-linearity                                      
                                                                          
    Inputs                                                                
      raw.fits DETLIN_DARK [3 to n]                        
      or raw.fits DETLIN_LAMP [3 to n]                     
                                                                          
    Outputs                                                               
      cr2res_cal_detlin_coeffs.fits CAL_DETLIN_COEFFS  
      cr2res_cal_detlin_bpm.fits CAL_DETLIN_BPM        
                                                                          
    Algorithm                                                             
      group the input raw frames by different settings                    
      loop on groups g:                                                   
        loop on detectors d:                                              
          cr2res_cal_detlin_reduce() computes bpm(g, d) and coeffs(g, d)  
          fill global_bpm(d) with bpm(g, d)                               
          fill global_coeffs(d) with coeffs(g, d)                         
                                                                          
        if (--single_settings)                                            
          save bpm(g) file                                                
          save coeffs(g) file                                             
      save global_bpm file                                                
      save global_coeffs file                                             
                                                                          
      cr2res_cal_detlin_reduce()                                          
        load input imlist and dits                                        
        compute the traces (from 1. image, or collapsed if --trace_collapse)
          use cr2res_trace(--trace_smooth, --trace_degree,                
                           --trace_min_cluster, --trace_opening)          
        loop on the detector pixels pix:                                  
          if the pixel is within a trace:                                 
            cr2res_detlin_compute() computes polynomial(pix) and errors(pix)
        use the coeffs for the bpm computation                            
        set the bad pixel coefficients as NaN                             
        store the qc parameters in the returned property list             
                                                                          
    Library Functions used                                                
      cr2res_trace()                                                      
      cr2res_detlin_compute()                                             
      cr2res_qc_detlin_gain()                                             
      cr2res_qc_detlin_median()                                           
      cr2res_qc_detlin_min_max_level()                                    
      cr2res_io_save_BPM()                                                
      cr2res_io_save_DETLIN_COEFFS()                                      
  

OPTIONS
  The following options are provided by this recipe.

  --bpm_kappa           : Kappa threshold for BPM detection. [1.8]
  --trace_degree        : polynomial degree for the fit to the orders. [2]
  --trace_min_cluster   : size in pixels of the smallest allowed cluster. [5000]
  --trace_smooth_x      : Length of the smoothing kernel in x. [111]
  --trace_smooth_y      : Length of the smoothing kernel in y. [401]
  --trace_threshold     : Detection Threshold. [1.0]
  --trace_opening       : Use a morphological opening to rejoin clusters. [TRUE]
  --single_settings     : Create the products for each setting. [FALSE]
  --trace_collapse      : Collapse the input frames for the trace analysis.
                          [TRUE]
  --detector            : Only reduce the specified detector. [0]
  --plot_x              : X position for the plot. [0]
  --plot_y              : Y position for the plot. [0]

\end{verbatim}
\subsection{cr2res\_cal\_dark}
\begin{verbatim}

NAME
  cr2res_cal_dark -- Dark recipe

SYNOPSIS
  esorex [esorex-options] cr2res_cal_dark [cr2res_cal_dark-options] sof

DESCRIPTION
  Dark                                                                    
    Compute the master dark                                               
                                                                          
    Inputs                                                                
      raw.fits DARK [3 to n]                               
                                                                          
    Outputs                                                               
      cr2res_cal_dark_[setting]_DITxNDIT_master.fits CAL_DARK_MASTER
      cr2res_cal_dark_[setting]_DITxNDIT_bpm.fits CAL_DARK_BPM
                                                                          
    Algorithm                                                             
      group the input frames by different values of DET SEQ1 DIT          
                 or/and DET NDIT or/and WLEN ID                           
      loop on groups g:                                                   
        loop on detectors d:                                              
          Load the images and create the associate error for each of      
                 them using cr2res_detector_shotnoise_model(--gain)       
          Collapse the images with hdrl_imagelist_collapse(--collapse.*)  
          Compute BPM from the collapsed master dark using                
                 cr2res_bpm_compute(--bpm_kappa, --bpm_lines_ratio)       
          Set the BPM in the master dark                                  
          Compute the QCs with statistics and                             
                 cr2res_dark_qc_ron(--ron_hsize, --ron_nsamples)          
        save master dark(g)                                               
        save bpm(g)                                                       
                                                                          
    Library Functions used                                                
      cr2res_detector_shotnoise_model()                                   
      cr2res_bpm_compute()                                                
      cr2res_bpm_from_mask()                                              
      cr2res_dark_qc_ron()                                                
      cr2res_bpm_count()                                                  
      cr2res_io_save_MASTER_DARK()                                        
      cr2res_io_save_BPM()                                                
  

OPTIONS
  The following options are provided by this recipe.

  --detector            : Only reduce the specified detector. [0]
  --bpm_method          : Method (DEFAULT, GLOBAL, LOCAL or RUNNING). [DEFAULT]
  --bpm_kappa           : Kappa Threshold for the BPM. [-1.0]
  --bpm_lines_ratio     : Maximum ratio of bad pixels per line. [0.5]
  --ron_hsize           : Half size of the window for RON computation. [6]
  --ron_nsamples        : Number of samples for RON computation. [100]
  --gain                : Gain in [e- / ADU]. [2.1]
  --collapse.method     : Method used for collapsing the data. <MEAN |
                          WEIGHTED_MEAN | MEDIAN | SIGCLIP | MINMAX> [MEAN]
  --collapse.sigclip.kappa-low  : Low kappa factor for kappa-sigma clipping
                                  algorithm. [3.0]
  --collapse.sigclip.kappa-high  : High kappa factor for kappa-sigma clipping
                                   algorithm. [3.0]
  --collapse.sigclip.niter  : Maximum number of clipping iterations for
                              kappa-sigma clipping. [5]
  --collapse.minmax.nlow: Low number of pixels to reject for the minmax clipping
                          algorithm. [1.0]
  --collapse.minmax.nhigh  : High number of pixels to reject for the minmax
                             clipping algorithm. [1.0]

\end{verbatim}
\subsection{cr2res\_obs\_nodding}
\begin{verbatim}

NAME
  cr2res_obs_nodding -- Nodding Observation recipe

SYNOPSIS
  esorex [esorex-options] cr2res_obs_nodding [cr2res_obs_nodding-options] sof

DESCRIPTION
  Nodding Observation                                                     
    This recipe handles nodding observations. It expects an even number   
    of rawframes in input, and as many A positions as B positions         
    If the input are standard stars, it computes a post processing step   
    to determine the throughput.                                          
    If the input are spectro astrometric data, it will apply the nodding  
    on each of the sub-groups                                             
                                                                          
    Inputs                                                                
      raw.fits CAL_NODDING_OTHER [2 to 2n]                  
            or CAL_NODDING_JITTER [2 to 2n]                 
            or OBS_NODDING_OTHER [2 to 2n]                  
            or OBS_NODDING_JITTER [2 to 2n]                 
            or OBS_ASTROMETRY_OTHER [2 to 2n]               
            or OBS_ASTROMETRY_JITTER [2 to 2n]              
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_MERGE                          
            or UTIL_BPM_SPLIT                          
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      master_flat.fits CAL_FLAT_MASTER [0 to 1]        
                                                                          
    Outputs                                                               
      cr2res_obs_nodding_extractA.fits OBS_NODDING_EXTRACTA
      cr2res_obs_nodding_extractB.fits OBS_NODDING_EXTRACTB
      cr2res_obs_nodding_combinedA.fits OBS_NODDING_COMBINEDA
      cr2res_obs_nodding_combinedB.fits OBS_NODDING_COMBINEDB
      cr2res_obs_nodding_modelA.fits OBS_NODDING_SLITMODELA
      cr2res_obs_nodding_modelB.fits OBS_NODDING_SLITMODELB
      cr2res_obs_nodding_slitfuncA.fits OBS_NODDING_SLITFUNCA
      cr2res_obs_nodding_slitfuncB.fits OBS_NODDING_SLITFUNCB
      cr2res_obs_nodding_throughput.fits OBS_NODDING_THROUGHPUT
                                                                          
    Algorithm                                                             
      loop on detectors d:                                                
        call cr2res_obs_nodding_reduce()                                  
          -> combined[a|b](d)                                             
          -> extract[a|b|c](d)                                            
          -> slitfunc[a|b](d)                                             
          -> model[a|b](d)                                                
          -> tw[a|b](d)                                                   
      Save combineda and combinedb                                        
      Save extracta, extractb, extractc                                   
      Save slitfunca and slitfuncb                                        
      Save modela and modelb                                              
      Save throughput                                                     
                                                                          
      cr2res_obs_nodding_reduce()                                         
        Load the input raw frames in an image list                        
        Apply the calibrations to the image list                          
        Split the list in listA and listB image lists                     
        Compute diffA=listA-listB and diffB=listB-listA                   
        Collapse diffA and diffB                                          
          -> combined[a|b]                                                
        Load the input trace wave                                         
        Compute the slit fractions for A and B by using the nodthrow      
                and the assumption that A and B are at equal distances    
                from the slit center.                                     
        Compute 2 new trace_wave files  with these 2 computed slit fractions
        Extract the spectra for A and for B                               
          -> extracted[a|b]                                               
          -> slit_func[a|b]                                               
          -> model_master[a|b]                                            
          -> trace_wave[a|b]                                              
        Compute QC parameters                                             
        If STD star, compute the throughput                               
          -> throughput                                                   
                                                                          
    Library functions used                                                
      cr2res_io_find_TRACE_WAVE()                                         
      cr2res_io_find_BPM()                                                
      cr2res_obs_nodding_reduce()                                         
      cr2res_nodding_read_positions()                                     
      cr2res_io_read_dits()                                               
      cr2res_io_load_image_list_from_set()                                
      cr2res_calib_imagelist()                                            
      cr2res_combine_nodding_split()                                      
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_pfits_get_nodthrow()                                         
      cr2res_trace_new_slit_fraction()                                    
      cr2res_extract_traces()                                             
      cr2res_qc_obs_nodding_signal()                                      
      cr2res_qc_obs_nodding_transmission()                                
      cr2res_qc_obs_nodding_slit_psf()                                    
      cr2res_photom_engine()                                              
      cr2res_io_save_COMBINED()                                           
      cr2res_io_save_EXTRACT_1D()                                         
      cr2res_io_save_SLIT_FUNC()                                          
      cr2res_io_save_SLIT_MODEL()                                         
      cr2res_io_save_THROUGHPUT()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --subtract_nolight_rows  : Subtract the no-light rows. [FALSE]
  --nodding_invert      : Flag to use when A is above B. [FALSE]
  --extract_oversample  : factor by which to oversample the extraction. [5]
  --extract_swath_width : The swath width. [800]
  --extract_height      : Extraction height. [-1]
  --extract_smooth_slit : Smoothing along the slit. [2.0]
  --extract_smooth_spec : Smoothing along spectrum. [8e-08]
  --detector            : Only reduce the specified detector. [0]
  --idp                 : Flag to produce  IDP files. [FALSE]
  --display_detector    : Apply the display for the specified detector. [0]
  --display_order       : Apply the display for the specified order. [1000]
  --display_trace       : Apply the display for the specified trace. [0]

\end{verbatim}
\subsection{cr2res\_util\_wave}
\begin{verbatim}

NAME
  cr2res_util_wave -- Wavelength Calibration

SYNOPSIS
  esorex [esorex-options] cr2res_util_wave [cr2res_util_wave-options] sof

DESCRIPTION
  Wavelength Calibration                                                  
    This utility performs the wavelength calibration on already extracted 
    spectra. It can support different methods (--wl_method parameter):    
      XCORR:  Cross Correlation with a emission lines catalog (default)   
      LINE1D: Line identification and fitting for each 1D spectra         
      LINE2D: Line identification and fitting for all 1D spectra at once  
      ETALON: Does not require any static calibration file                
      AUTO:   Guess the Method from the input file header                 
                                                                          
    Inputs                                                                
      raw.fits CAL_FLAT_EXTRACT_1D [1 to n]            
            or UTIL_EXTRACT_1D                         
            or UTIL_WAVE_EXTRACT_1D                    
            or CAL_WAVE_EXTRACT_1D                     
            or OBS_NODDING_EXTRACTA                    
            or OBS_NODDING_EXTRACTB                    
            or OBS_NODDING_EXTRACT_COMB                    
            or OBS_STARING_EXTRACT                     
      trace.fits CAL_FLAT_TW [1]                       
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      lines.fits EMISSION_LINES [0 to 1]               
                                                                          
    Outputs                                                               
      <input_name>_tw.fits UTIL_WAVE_TW
      <input_name>_wave_map.fits UTIL_WAVE_MAP
      <input_name>_lines_diagnostics.fits UTIL_WAVE_LINES_DIAGNOSTICS
      <input_name>_extracted.fits UTIL_WAVE_EXTRACT_1D
                                                                          
    Algorithm                                                             
      loop on raw frames f:                                               
        loop on detectors d:                                              
          Load the trace wave tw(f,d)                                     
          Load the extracted spectra table ext(f,d)                       
          Call cr2res_wave_apply(tw(f,d),ext(f,d),emission_lines)         
              -> lines diagnostics(f,d)                                   
              -> updated_extracted(f,d)                                   
              -> trace_wave_out(f,d)                                      
          Create the wavelength map wave_map(f,d)                         
        Save lines diagnostics(f)                                         
        Save updated_extracted(f)                                         
        Save wave_map(f)                                                  
        Save trace_wave_out(f)                                            
                                                                          
      cr2res_wave_apply()                                                 
        loop on the traces t:                                             
          Get the spectrum                                                
          Get the Initial guess                                           
          Switch on the required method:                                  
            CR2RES_LINE2D: cr2res_wave_2d()                               
            CR2RES_LINE1D: cr2res_wave_line_fitting()                     
            CR2RES_ETALON: cr2res_wave_etalon()                           
            CR2RES_XCORR:  cr2res_wave_xcorr()                            
                                                                          
    Library Functions used                                                
      cr2res_io_find_TRACE_WAVE()                                         
      cr2res_io_load_TRACE_WAVE()                                         
      cr2res_io_load_EXTRACT_1D()                                         
      cr2res_wave_apply()                                                 
      cr2res_extract_EXTRACT1D_get_spectrum()                             
      cr2res_wave_estimate_compute()                                      
      cr2res_wave_2d()                                                    
      cr2res_wave_line_fitting()                                          
      cr2res_wave_etalon()                                                
      cr2res_wave_xcorr()                                                 
      cr2res_wave_gen_wave_map()                                          
      cr2res_io_save_TRACE_WAVE()                                         
      cr2res_io_save_WAVE_MAP()                                           
      cr2res_io_save_LINES_DIAGNOSTICS()                                  
      cr2res_io_save_EXTRACT_1D()                                         
  

OPTIONS
  The following options are provided by this recipe.

  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]
  --wl_method           : Wavelength Method (XCORR / LINE1D / LINE2D / ETALON).
                          [UNSPECIFIED]
  --wl_shift            : Wavelength shift (nm) to apply to the guess. [0.0]
  --wl_est              : Estimated wavelength [start, end] (in nm). [-1.0,
                          -1.0]
  --wl_err              : Estimated wavelength error (in nm). [-1.0]
  --wl_degree           : Wavelength Polynomial degree. [2]
  --log                 : Flag for taking the Log() value of the lines. [FALSE]
  --fallback            : Flag for using the input WL when no computation.
                          [FALSE]
  --keep                : Flag for re-using higher degrees of first guess in
                          Cross-Corr. [FALSE]
  --clean_spectrum      : Clean spectrum to use only around catalogue lines.
                          [TRUE]
  --display             : Flag for display. [FALSE]
  --display_range       : Wavelength range to display [start, end] (in nm).
                          [-1.0, -1.0]

\end{verbatim}
\subsection{cr2res\_cal\_flat}
\begin{verbatim}

NAME
  cr2res_cal_flat -- Flat recipe

SYNOPSIS
  esorex [esorex-options] cr2res_cal_flat [cr2res_cal_flat-options] sof

DESCRIPTION
  Flat                                                                    
    Compute the master flat and perform the traces detection.             
    If a TW file is provided, its traces and slit curvatures are used     
    for the extraction needed to create the master flat.                  
    If not provided, the measured traces are used, and the slit is        
    considered vertical.                                                  
                                                                          
    Inputs                                                                
      raw.fits FLAT [1 to n]                               
      trace.fits CAL_FLAT_TW [0 to 1]                  
              or CAL_FLAT_TW_MERGED                    
              or UTIL_TRACE_TW                         
              or UTIL_WAVE_TW                          
              or CAL_WAVE_TW                           
              or UTIL_SLIT_CURV_TW                     
      detlin.fits CAL_DETLIN_COEFFS [0 to 1]           
      master_dark.fits CAL_DARK_MASTER [0 to 1]        
      bpm.fits CAL_DARK_BPM [0 to 1]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_SPLIT                          
            or UTIL_NORM_BPM                           
                                                                          
    Outputs                                                               
      cr2res_cal_flat_[setting]_[Decker]_bpm.fits CAL_FLAT_BPM
      cr2res_cal_flat_[setting]_[Decker]_blaze.fits CAL_FLAT_EXTRACT_1D
      cr2res_cal_flat_[setting]_[Decker]_slit_model.fits CAL_FLAT_SLIT_MODEL
      cr2res_cal_flat_[setting]_[Decker]_slit_func.fits CAL_FLAT_SLIT_FUNC
      cr2res_cal_flat_[setting]_[Decker]_master_flat.fits CAL_FLAT_MASTER
      cr2res_cal_flat_[setting]_[Decker]_tw.fits CAL_FLAT_TW
      cr2res_cal_flat_[setting]_tw_merged.fits CAL_FLAT_TW_MERGED
                                                                          
    Algorithm                                                             
      group the input frames by different settings                        
      loop on groups g:                                                   
        loop on decker positions p:                                       
          loop on detectors d:                                            
            cr2res_cal_flat_reduce() computes (master_flat, trace_wave,   
                   slit_func,extract_1d,slit_model,bpm)(g,p,d)            
          Save slit_model(g,p)                                            
          Save extract_1d(g,p)                                            
          Save master_flat(g,p)                                           
          Save trace_wave(g,p)                                            
          Save slit_func(g,p)                                             
          Save bpm(g,p)                                                   
        Merge the trace_wave(g,p,d) into trace_wave(g,d)                  
        Save trace_wave(g)                                                
                                                                          
      cr2res_cal_flat_reduce()                                            
        Load the images list                                              
        Apply the detlin / dark / bpm calibrations                        
        Average the images to avg                                         
        Compute the traces with cr2res_trace(--trace_degree,              
                   --trace_min_cluster, --trace_smooth, --trace_opening)  
                  on avg                                                  
        For the following step, the computed TW is used if there is no    
        input TW provided, the provided one is used otherwise.            
        loop on the traces t:                                             
          cr2res_extract_slitdec_curved(--extract_oversample,             
                   --extract_swath_width, --extract_height,               
                   --extract_smooth_slit)                                      
            -> slit_func(t), extract_1d(t), slit_model(t)                 
        Compute the master flat with cr2res_master_flat(avg, slit_model,  
                   --bpm_low, --bpm_high, --bpm_lines_ratio)              
          -> master_flat, bpm                                             
        Merge the bpm with the input bpm                                  
        Compute QCs                                                       
        store the qc parameters in the returned property list             
                                                                          
    Library functions used:                                               
      cr2res_io_extract_decker_frameset()                                 
      cr2res_trace()                                                      
      cr2res_extract_slitdec_curved()                                     
      cr2res_master_flat()                                                
      cr2res_qc_flat_lamp_ints()                                          
      cr2res_qc_flat_mean_level()                                         
      cr2res_qc_flat_mean_med_flux()                                      
      cr2res_qc_flat_med_snr()                                            
      cr2res_qc_overexposed()                                             
      cr2res_qc_flat_trace_center_y()                                     
      cr2res_trace_merge()                                                
      cr2res_io_save_SLIT_MODEL()                                         
      cr2res_io_save_EXTRACT_1D()                                         
      cr2res_io_save_MASTER_FLAT()                                        
      cr2res_io_save_TRACE_WAVE()                                         
      cr2res_io_save_SLIT_FUNC()                                          
      cr2res_io_save_BPM()                                                
  

OPTIONS
  The following options are provided by this recipe.

  --subtract_nolight_rows  : Subtract the no-light rows. [FALSE]
  --calib_cosmics_corr  : Correct the Cosmics. [FALSE]
  --bpm_low             : Low threshold for BPM detection. [0.8]
  --bpm_high            : High threshold for BPM detection. [1.2]
  --bpm_lines_ratio     : Maximum ratio of bad pixels per line. [0.5]
  --trace_degree        : polynomial degree for the fit to the orders. [2]
  --trace_min_cluster   : size in pixels of the smallest allowed cluster.
                          [200000]
  --trace_smooth_x      : Length of the smoothing kernel in x. [111]
  --trace_smooth_y      : Length of the smoothing kernel in y. [401]
  --trace_threshold     : Detection Threshold. [3.0]
  --trace_opening       : Use a morphological opening to rejoin clusters. [TRUE]
  --extract_method      : Extraction method (SUM / MEDIAN / TILTSUM / OPT_VERT /
                          OPT_CURV ). [OPT_CURV]
  --extract_oversample  : factor by which to oversample the extraction. [5]
  --extract_swath_width : The swath width. [800]
  --extract_height      : Extraction height. [-1]
  --extract_smooth_slit : Smoothing along the slit. [3.0]
  --detector            : Only reduce the specified detector. [0]
  --order               : Only reduce the specified order. [-1]
  --trace_nb            : Only reduce the specified trace number. [-1]

\end{verbatim}
\subsection{cr2res\_util\_bpm\_merge}
\begin{verbatim}

NAME
  cr2res_util_bpm_merge -- BPM merging utility

SYNOPSIS
  esorex [esorex-options] cr2res_util_bpm_merge [cr2res_util_bpm_merge-options] sof

DESCRIPTION
  BPM merging                                                             
    Each input BPM is splitted into several BPMs                          
                                                                          
    Inputs                                                                
     	raw.fits CAL_DARK_BPM [1 to n]                   
            or CAL_FLAT_BPM                            
            or CAL_DETLIN_BPM                          
            or UTIL_BPM_SPLIT                          
            or UTIL_BPM_MERGE                          
            or UTIL_NORM_BPM                           
                                                                          
    Outputs                                                               
      <recipe_name>.fits UTIL_BPM_MERGE
                                                                          
    Algorithm         TODO                                                
                                                                          
    Library functions used:                                               
      cr2res_io_load_BPM()        TODO                                    
      cr2res_io_save_BPM()                                                
  

OPTIONS
  A single option is provided by this recipe.

  --detector            : Only reduce the specified detector. [0]

\end{verbatim}
