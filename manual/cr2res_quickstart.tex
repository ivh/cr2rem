\section{Data Reduction Cook-Book}
\label{sec:cookbook}

%\red{\textit{Cookbook-like description of pipeline recipes and their usage}}

\subsection{Getting Started with \esorex{}}
\label{sec:esorex-quick}

\textit{\esorex{}} is a command-line tool which can be used to execute the
recipes of all standard VLT/VLTI instrument pipelines. With \textit{\esorex{}}
in your path, the general structure of an \textit{\esorex{}} 
command line is

\begin{shell}[fontsize=\small]
%prompt esorex [esorex options] [recipe [recipe options] [sof [sof]...]]
\end{shell}

where options appearing before the recipe name are options for
\textit{\esorex{}} itself, and options given after the recipe name are options
which affect the recipe. 

All available \textit{\esorex{}} options can be listed with the command
\begin{shell}[fontsize=\small]
%prompt esorex --help
\end{shell}

and the full list of available parameters of a specific recipe can be obtained
with the command 

\begin{shell}[fontsize=\small]
%prompt esorex --help <recipe name>
\end{shell}
The output of this command shows as parameter values the current setting, \ie
all modifications from a configuration file or the command line are already
applied.

The listing of all recipes known to \textit{\esorex{}} can be obtained with the command
\begin{shell}[fontsize=\small]
%prompt esorex --recipes
\end{shell}

The last arguments of an \textit{\esorex{}} command are the so-called
\textit{set-of-frames}. A \textit{set-of-frames} is a simple text file which
contains a list of input data files for the recipe. Each input file is
followed by an unique identifier (frame classification or frame tag),
indicating the contents of this file. The input files have to be given as an
absolute path, however \textit{\esorex{}} allows the use of environment variables so
that a common directory prefix can be abreviated. Individual lines may be
commented out by putting the hash character (\texttt{\#}) in the first
column. An example of a \textit{set-of-frames} is shown in the following:

\begin{shell}[fontsize=\small]
%prompt cat darks.sof
/data/crires/CRIRES.2019-03-29T09:50:36.645.fits DARK
$RAW_DATA/CRIRES.2019-03-29T09:52:16.513.fits DARK
$RAW_DATA/CRIRES.2019-03-29T09:53:47.996.fits DARK
#$RAW_DATA/CRIRES.2019-03-29T09:55:04.515.fits DARK
#$RAW_DATA/dark5.fits DARK
\end{shell}

These \textit{set-of-frames} files will have to be created by the user using a
text editor, for instance.

Finally, if more than one \textit{set-of-frames} is given on the command-line
\textit{\esorex{}} concatenates them into a single \textit{set-of-frames}.


\subsection{Calibration, made easy}
\label{sec:simcalexpl}
This example follows the data flow described in \ref{sec:simplecalib}. It makes
use of a pre-existing TW-table, for example the one from the CalibDB, for order
traces and slit-tilt. All data needs to match in spectrograph setting.

\texttt{cr2res\_cal\_dark} only receives raw frames, so the SOF looks like the
one just above and gets processed like
\begin{shell}[fontsize=\small]
  %prompt esorex cr2res_cal_dark darks.sof
\end{shell}  
The outputs are master darks and BPM. The recipe parameters influence how
outliers are rejected and where to put the threshold for rejecting pixels as
bad. The default values should give good results.

Next are the FLATs.
\begin{shell}[fontsize=\small]
%prompt cat flats.sof
$RAW/flat1.fits
$RAW/flat2.fits
$RAW/flat3.fits
$CALIB/dark_bpm.fits    CAL_DARK_BPM
$CALIB/dark_master.fits CAL_DARK_MASTER
$CALIB/tw.fits          UTIL_WAVE_TW
cr2res_detlin_coeffs.fits  CAL_DETLIN_COEFFS

%prompt esorex cr2res_cal_flat flats.sof
\end{shell}
The main data product is the normalized flat-field (\verb!PRO.CATG=CAL_FLAT_MASTER!).


For wavelength-calibration, both the UNE and FPET frames should best be provided
at once:
\begin{shell}[fontsize=\small]
%prompt cat wave.sof
$RAW/une.fits
$RAW/fpet.fits
$CALIB/dark_bpm.fits    CAL_DARK_BPM
$CALIB/dark_2s_master.fits CAL_DARK_MASTER
$CALIB/tw.fits          UTIL_WAVE_TW
$CALIB/cr2res_detlin_coeffs.fits  CAL_DETLIN_COEFFS

%prompt esorex cr2res_cal_wave wave.sof
\end{shell}
This produces a new TW, with updated wavelength solutions and retaining information like the order traces from the input TW.

In this simplified reduction, we rely on a pre-existing TW for traces and slit-tilt, and pre-made non-linearity correction. This normally should not negatively impact the quality of the data products, especially when metrology is used to increase the repeatability of the instrument.

%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
\subsection{Examples of science reductions}

\subsubsection{Nodding}

An example SOF and esorex-call for \verb!cr2res_obs_nodding! were already shown
in Ch.~\ref{sec:sci-reduc} and there really is not much more to it. Note that
there is no master-dark provided, and indeed it is not recommended doing so,
because it likely worsens the results compared to relying on the subtraction of
A and B frames from each other for removing detector features and background.

An aspect to consider is how much of an observed nodding sequence is given to
the recipe at a time. It will combine all the A-frames and all B-frames (saved
as \verb!PRO.CATG=OBS_NODDING_COMBINED[AB]!), then do the pair-wise subtraction
and spectrum extraction, resulting in a single set of spectra (from all
detector-orders) for A, and one for B (\verb!OBS_NODDING_EXTRACT[AB]!).
Therefore, if time-evolution plays a role in the science, a set of data might
need to be split up and reduced individually. An equal number of frames for
positions A and B always needs to be supplied.

The recipe also produces spectra that are combined from A and B
(\verb!OBS_NODDING_EXTRACT_COMB!). This naturally involves resampling and
relying on the wavelength scale, because the tilted slit makes the spectral
binning different between the top and bottom halves of the slit. This is why the
spectra \emph{before} this combination are considered the primary data product.
Note also that the combination is done as an average, which has to be taken into
account as a factor of 2 when interpreting the level of ADU.

The jitter around positions A and B does not need to be treated explicitly by
the DRS. Instead it makes use of the fact that the extraction algorithm
(cf.~\ref{sec:extract}) can handle arbitrary slit-illumination functions, in
this case the combined frame simply looks like multiple "stars" along the slit.

A few parameters can be tweaked to potentially improve results. If there remain
detector features that correlate with the detector columns in the combined
frames, as has sometimes been found to be the case,
\verb!--subtract_nolight_rows! can be set to \verb!TRUE!. This makes use of the
bottom 40 rows of the detectors which are intentionally baffled to not receive
light. A vertical median over these rows is calculated, and the result subtracted
from the image row-by-row.

The oversampling of the slit-function can be changed via
\verb!--extract_oversample!. This affects linearly the calculation effort of the
extraction, which in turn is the bulk of the total recipe runtime, so that
increasing the oversampling from a factor of 5 to 10 means the reduction takes
twice as long. In general, values below 5 give suboptimal results and values
above 10 are appropriate when the slit-illumination changes sharply. See
Ch.~\ref{sec:extract} for more details.


\subsubsection{Staring}

\verb!cr2res_obs_staring! is very similar to \verb!cr2res_obs_nodding!, except
the nodding part. Thus, a master-dark should be supplied in the SOF, in addition
to the other files:
\begin{shell}[fontsize=\small]
%prompt cat stare.sof
$RAW/stare_exp1.fits        OBS_STARING_JITTER
$RAW/stare_exp2.fits        OBS_STARING_JITTER
$RAW/stare_exp3.fits        OBS_STARING_JITTER
$RAW/stare_exp4.fits        OBS_STARING_JITTER
$RAW/stare_exp5.fits        OBS_STARING_JITTER
$CALIB/K2192_masterflat.fits                  CAL_MASTER_FLAT
$CALIB/K2192_tw.fits                          UTIL_WAVE_TW
$CALIB/cr2res_cal_dark_K2192_bpm.fits         CAL_DARK_BPM
$CALIB/cr2res_cal_dark_K2192_30s_master.fits  CAL_DARK_MASTER
$CALIB/cr2res_detlin_coeffs.fits              CAL_DETLIN_COEFFS
\end{shell}  
Ideally, the DARK frames used match the DIT of the science frames.

If the target is always close to the center of the slit, one can decrease the extraction height for speedup.
\begin{shell}[fontsize=\small]
  %prompt esorex --extract_height=50 cr2res_obs_staring stare.sof
\end{shell}  


\subsubsection{Generic Offset}

This was not offered during P108, so the example will be added in a
future iteration of this document.

\subsubsection{Polarimetry}

This was not offered during P108, so the example will be added in a
future iteration of this document.

\subsubsection{Spectro-Astrometry}

This was not offered during P108, so the example will be added in a
future iteration of this document.


\subsection{Optional Steps}

\subsubsection{Refining the BPM}

Using only the BPM that comes from \texttt{cr2res\_cal\_dark} usually gives
satisfactory results. However, pixels can be marked as bad also by detecting
them as being outliers in their non-linearity behavior, or in their overall
sensitivity as seen in the normalized flat-field.

The recipe \texttt{cr2res\_util\_bpm\_merge} allows you to merge these BPMs into
a combined BPM, to be used for subsequent reduction steps.
\texttt{cr2res\_util\_bpm\_split} does the inverse, that is splitting a BPM into
its original components. A pixel can be marked as bad in more than one way and
this is being kept track of.

\subsubsection{Splicing and Continuum Normalization}

Give the blaze function and spectra from several settings to
\texttt{cr2res\_util\_splice} and it will divide by the blaze and then resample
the overlap-regions between all spectra from individual detector-orders to be
able to do a weighted average. The result is one continuous spectrum.

Please note that this recipe has not been tested extensively to produce reliable
results in all cases. For now its data products should therefore be considered
experimental and quality not ensured to be "science-ready".


\subsection{Calibration, from scratch}
\label{sec:calibscratch}
Following the steps outlined in Ch.~\ref{sec:stepcalib} and accompanying text,
we can reduce the calibrations without relying on pre-existing reduction
products like the TW. This is also the way the CalibDB is being assembled. The
following gives example SOFs and recipe calls to reduce a single setting.

First the SOFs:
\begin{shell}[fontsize=\footnotesize]
%prompt cat 01_cr2res_cal_dark.sof
CRIRE.2021-09-16T20:58:23.580.fits      DARK     
CRIRE.2021-09-16T20:58:40.524.fits      DARK     
CRIRE.2021-09-16T20:58:57.146.fits      DARK     
CRIRE.2021-09-16T20:59:13.835.fits      DARK     
CRIRE.2021-09-16T20:59:30.110.fits      DARK     
CRIRE.2021-09-16T20:59:46.468.fits      DARK     
CRIRE.2021-09-16T21:00:08.583.fits      DARK     
CRIRE.2021-09-16T21:02:14.863.fits      DARK     
CRIRE.2021-09-16T21:04:21.006.fits      DARK     
CRIRE.2021-09-16T21:06:27.987.fits      DARK     
CRIRE.2021-09-16T21:06:54.976.fits      DARK     
CRIRE.2021-09-16T21:07:21.609.fits      DARK     
CRIRE.2021-09-16T21:07:48.034.fits      DARK     
CRIRE.2021-09-16T21:07:57.532.fits      DARK     
CRIRE.2021-09-16T21:08:06.919.fits      DARK     

%prompt cat 02_cr2res_util_calib.sof
../cr2res_cal_detlin_coeffs.fits CAL_DETLIN_COEFFS
CRIRE.2021-09-16T20:49:23.778.fits      FLAT     
01_cr2res_cal_dark_out/cr2res_cal_dark_Y1028_3_bpm.fits CAL_DARK_BPM
01_cr2res_cal_dark_out/cr2res_cal_dark_Y1028_3_master.fits CAL_DARK_MASTER

%prompt cat 03_cr2res_util_trace.sof
02_cr2res_util_calib_out/cr2res_util_calib_calibrated_collapsed.fits    UTIL_CALIB

%prompt cat 04_cr2res_util_slit_curv.sof
CRIRE.2021-09-16T20:54:28.992.fits      WAVE_FPET
03_cr2res_util_trace_out/cr2res_util_calib_calibrated_collapsed_tw.fits  CAL_FLAT_TW

%prompt cat 05_cr2res_util_extract.sof
02_cr2res_util_calib_out/cr2res_util_calib_calibrated_collapsed.fits UTIL_CALIB
04_cr2res_util_slit_curv_out/cr2res_util_calib_calibrated_collapsed_tw_tw.fits UTIL_SLIT_CURV_TW
#03_cr2res_util_trace_out/cr2res_util_calib_calibrated_collapsed_tw.fits UTIL_TRACE_TW

%prompt cat 06_cr2res_util_normflat.sof
02_cr2res_util_calib_out/cr2res_util_calib_calibrated_collapsed.fits UTIL_CALIB
05_cr2res_util_extract_out/cr2res_util_calib_calibrated_collapsed_extrModel.fits UTIL_SLIT_MODEL

%prompt cat 07_cr2res_util_calib.sof
../cr2res_cal_detlin_coeffs.fits CAL_DETLIN_COEFFS
CRIRE.2021-09-16T20:50:11.966.fits      WAVE_UNE 
01_cr2res_cal_dark_out/cr2res_cal_dark_Y1028_20_bpm.fits CAL_DARK_BPM
01_cr2res_cal_dark_out/cr2res_cal_dark_Y1028_20_master.fits CAL_DARK_MASTER
06_cr2res_util_normflat_out/cr2res_util_normflat_Open_master_flat.fits CAL_FLAT_MASTER

%prompt cat 08_cr2res_util_extract.sof
07_cr2res_util_calib_out/cr2res_util_calib_calibrated_collapsed.fits UTIL_CALIB
04_cr2res_util_slit_curv_out/cr2res_util_calib_calibrated_collapsed_tw_tw.fits UTIL_SLIT_CURV_TW

%prompt cat 09_cr2res_util_genlines.sof
../lines_u_sarmiento.txt EMISSION_LINES_TXT
une_sel.dat LINES_SELECTION_TXT

%prompt # there is no step 10
%prompt cat 11_cr2res_util_wave.sof
08_cr2res_util_extract_out/cr2res_util_calib_calibrated_collapsed_extr1D.fits UTIL_EXTRACT_1D
04_cr2res_util_slit_curv_out/cr2res_util_calib_calibrated_collapsed_tw_tw.fits UTIL_SLIT_CURV_TW
09_cr2res_util_genlines_out/lines_u_sarmiento_une_sel.fits EMISSION_LINES

%prompt cat 12_cr2res_util_wave.sof
08_cr2res_util_extract_out/cr2res_util_calib_calibrated_collapsed_extr1D.fits UTIL_EXTRACT_1D
11_cr2res_util_wave_out/cr2res_util_calib_calibrated_collapsed_extr1D_tw.fits UTIL_SLIT_CURV_TW
09_cr2res_util_genlines_out/lines_u_sarmiento_une_sel.fits EMISSION_LINES

%prompt cat 13_cr2res_util_calib.sof
../cr2res_cal_detlin_coeffs.fits CAL_DETLIN_COEFFS
CRIRE.2021-09-16T20:54:28.992.fits      WAVE_FPET
01_cr2res_cal_dark_out/cr2res_cal_dark_Y1028_120_bpm.fits CAL_DARK_BPM
01_cr2res_cal_dark_out/cr2res_cal_dark_Y1028_120_master.fits CAL_DARK_MASTER
06_cr2res_util_normflat_out/cr2res_util_normflat_Open_master_flat.fits CAL_FLAT_MASTER

%prompt cat 14_cr2res_util_extract.sof
13_cr2res_util_calib_out/cr2res_util_calib_calibrated_collapsed.fits UTIL_CALIB
11_cr2res_util_wave_out/cr2res_util_calib_calibrated_collapsed_extr1D_tw.fits UTIL_SLIT_CURV_TW

%prompt cat 15_cr2res_util_wave.sof
14_cr2res_util_extract_out/cr2res_util_calib_calibrated_collapsed_extr1D.fits UTIL_EXTRACT_1D
11_cr2res_util_wave_out/cr2res_util_calib_calibrated_collapsed_extr1D_tw.fits UTIL_WAVE_TW
\end{shell}

The commands to execute the steps are:
\begin{shell}[fontsize=\footnotesize]
esorex --log-file=01_cr2res_cal_dark.log --output-dir=01_cr2res_cal_dark_out cr2res_cal_dark 
  01_cr2res_cal_dark.sof
esorex --log-file=02_cr2res_util_calib.log --output-dir=02_cr2res_util_calib_out 
  cr2res_util_calib --collapse="MEAN" 02_cr2res_util_calib.sof
esorex --log-file=03_cr2res_util_trace.log --output-dir=03_cr2res_util_trace_out    
  cr2res_util_trace 03_cr2res_util_trace.sof
esorex --log-file=04_cr2res_util_slit_curv.log --output-dir=04_cr2res_util_slit_curv_out
  cr2res_util_slit_curv 04_cr2res_util_slit_curv.sof
esorex --log-file=05_cr2res_util_extract.log --output-dir=05_cr2res_util_extract_out
  cr2res_util_extract --smooth_slit=3 -smooth_spec=2.0E-7 
  05_cr2res_util_extract.sof
esorex --log-file=06_cr2res_util_normflat.log --output-dir=06_cr2res_util_normflat_out 
  cr2res_util_normflat 06_cr2res_util_normflat.sof
esorex --log-file=07_cr2res_util_calib.log --output-dir=07_cr2res_util_calib_out 
  cr2res_util_calib --collapse="MEAN" --subtract_nolight_rows=TRUE 07_cr2res_util_calib.sof
esorex --log-file=08_cr2res_util_extract.log --output-dir=08_cr2res_util_extract_out  
  cr2res_util_extract --smooth_slit=3  08_cr2res_util_extract.sof
esorex --log-file=09_cr2res_util_genlines.log  --output-dir=09_cr2res_util_genlines_out  
  cr2res_util_genlines 09_cr2res_util_genlines.sof
esorex --log-file=11_cr2res_util_wave.log --output-dir=11_cr2res_util_wave_out 
  cr2res_util_wave --wl_method=XCORR --wl_degree=0 --keep --wl_err=0.1 --fallback 
11_cr2res_util_wave.sof
esorex --log-file=12_cr2res_util_wave.log --output-dir=12_cr2res_util_wave_out 
  cr2res_util_wave --wl_method=XCORR --wl_degree=2 --wl_err=0.03 --fallback 
  12_cr2res_util_wave.sof
esorex --log-file=13_cr2res_util_calib.log --output-dir=13_cr2res_util_calib_out 
  cr2res_util_calib --collapse="MEAN" 13_cr2res_util_calib.sof
esorex --log-file=14_cr2res_util_extract.log --output-dir=14_cr2res_util_extract_out 
  cr2res_util_extract --smooth_slit=3 14_cr2res_util_extract.sof
esorex --log-file=15_cr2res_util_wave.log --output-dir=15_cr2res_util_wave_out 
  cr2res_util_wave --wl_method=ETALON --wl_degree=4 --fallback 15_cr2res_util_wave.sof
\end{shell}


A few notes on the recipe parameters used:
\begin{enumerate}
  \item[2.] Remember, without \verb!--collapse! the recipe would loop over the
  flat-field frames, dark-subtracting each, instead of doing so on the combined
  frame.
  \item[5.] Extracting the flat-field frames, we know the slit is evenly
  illuminated, so we can apply some extra smoothing along the slit. The slight
  smoothing (regularization, actually) of the blaze spectrum is necessary
  because there are column-by-column variations in the detectors that would
  otherwise become part of the blaze, not part of the normalized flat-field, as
  inteded.
  \item[7.] For short exposures the detector background-level can vary
  significantly, so we use \verb! --subtract_nolight_rows! to somewhat improve
  on sub-optimal dark-subtraction.
  \item[9.] The first pass of cross-correlation with a sufficiently large
  search-radius (\verb!--wl_err!). \verb!--wl_degree=0! means that only a shift
  in the zero-point is allowed, which means that we have to \verb!--keep! the
  higher degrees of the input solution polynomial.
  \item[11.] In the second pass we decrease the search radius and increase the
  degree.
  \item[15.] The numerous and regular lines of the FPET allow a polynomial with
  even higher degree.
  \item[9,11,15.] Without \verb!--fallback! the output would, in case of an
  error in a detector-order, not contain a solution for this order, thus
  precluding it from subsequent steps. With this option, the input solution gets
  propagated into the output, in case calibration fails.
\end{enumerate}
%%%%%%%%%%%%%%

%\subsubsection{Getting Started with \gasgano{}}
%\label{sec:gasgano-quick}

%\red{\textit{{Basic description of Gasgano and its usage with \instrument{} and
%   its recipes. Maybe omitted if Gasgano, for technical reasons cannot be
%   supported (MUSE memory requirements for instance). If present, major parts
%   will be provided by ESO.}}}


% \subsection{Data Organization}
% \label{sec:dataorganization}

% \red{\textit{Outline of how to organize \instrument{} data, i.e. how to get to
%     a correct SOF file, which classification tags are accepted by the recipes
%     and how they are defined in terms of header keywords.}}

