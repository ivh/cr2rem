\section{Data Reduction Cook-Book}
\label{sec:cookbook}

%\red{\textit{Cookbook-like description of pipeline recipes and their usage}}


\subsection{Executing Recipes}
\label{sec:exec-recipes-quick}


\subsubsection{Getting Started with \esorex{}}
\label{sec:esorex-quick}

\textit{\esorex{}} is a command-line tool which can be used to execute the
recipes of all standard VLT/VLTI instrument pipelines. With \textit{\esorex{}}
in your path, the general structure of an \textit{\esorex{}} 
command line is

\begin{shell}[fontsize=\small]
%prompt esorex [esorex options] [recipe [recipe options] [sof [sof]...]]
\end{shell}

where options appearing before the recipe name are options for
\textit{\esorex{}} itself, and options given after the recipe name are options
which affect the recipe. 

All available \textit{\esorex{}} options can be listed with the command
\begin{shell}[fontsize=\small]
%prompt esorex --help
\end{shell}

and the full list of available parameters of a specific recipe can be obtained
with the command 

\begin{shell}[fontsize=\small]
%prompt esorex --help <recipe name>
\end{shell}
The output of this command shows as parameter values the current setting, \ie
all modifications from a configuration file or the command line are already
applied.

The listing of all recipes known to \textit{\esorex{}} can be obtained with the command
\begin{shell}[fontsize=\small]
%prompt esorex --recipes
\end{shell}

The last arguments of an \textit{\esorex{}} command are the so-called
\textit{set-of-frames}. A \textit{set-of-frames} is a simple text file which
contains a list of input data files for the recipe. Each input file is
followed by an unique identifier (frame classification or frame tag),
indicating the contents of this file. The input files have to be given as an
absolute path, however \textit{\esorex{}} allows the use of environment variables so
that a common directory prefix can be abreviated. Individual lines may be
commented out by putting the hash character (\texttt{\#}) in the first
column. An example of a \textit{set-of-frames} is shown in the following:

\begin{shell}[fontsize=\small]
%prompt cat darks.sof
/data/crires/CRIRES.2019-03-29T09:50:36.645.fits DARK
$RAW_DATA/CRIRES.2019-03-29T09:52:16.513.fits DARK
$RAW_DATA/CRIRES.2019-03-29T09:53:47.996.fits DARK
#$RAW_DATA/CRIRES.2019-03-29T09:55:04.515.fits DARK
#$RAW_DATA/dark5.fits DARK
\end{shell}

These \textit{set-of-frames} files will have to be created by the user using a
text editor, for instance.

Finally, if more than one \textit{set-of-frames} is given on the command-line
\textit{\esorex{}} concatenates them into a single \textit{set-of-frames}.


\subsubsection{Calibration, made easy}

This example follows the data flow described in \ref{sec:simplecalib}. It makes
use of a pre-existing TW-table, for example the one from the CalibDB, for order
traces and slit-tilt. All data needs to match in spectrograph setting.

\texttt{cr2res\_cal\_dark} only receives raw frames, so the SOF looks like the
one just above and gets processed like
\begin{shell}[fontsize=\small]
  %prompt esorex cr2res_cal_dark darks.sof
\end{shell}  
The outputs are master darks and BPM. The recipe parameters influence how
outliers are rejected and where to put the threshold for rejecting pixels as
bad. The default values should give good results.

Next are the FLATs.
\begin{shell}[fontsize=\small]
  %prompt cat flat.sof
$RAW/flat1.fits
$RAW/flat2.fits
$RAW/flat3.fits
$CALIB/dark_bpm.fits CAL_DARK_BPM
$CALIB/dark_master.fits CAL_DARK_MASTER
$CALIB/tw.fits UTIL_WAVE_TW
\end{shell}  

\subsection{Examples of science reductions}

\subsubsection{Nodding}

\ldots

\subsubsection{Staring}

\subsubsection{Generic Offset}

This was not offered during P108, so the example will be added in a
future iteration of this document.

\subsubsection{Polarimetry}

This was not offered during P108, so the example will be added in a
future iteration of this document.

\subsubsection{Spectro-Astrometry}

This was not offered during P108, so the example will be added in a
future iteration of this document.


\subsection{Optional Steps}

combine BPMs

util\_splice


\subsection{Calibration, from scratch}
\label{sec:calibscratch}
Following the steps outlined in Ch.~\ref{sec:stepcalib}, we can reduce the
calibrations without relying on pre-existing reduction products like the TW.




%%%%%%%%%%%%%%

%\subsubsection{Getting Started with \gasgano{}}
%\label{sec:gasgano-quick}

%\red{\textit{{Basic description of Gasgano and its usage with \instrument{} and
%   its recipes. Maybe omitted if Gasgano, for technical reasons cannot be
%   supported (MUSE memory requirements for instance). If present, major parts
%   will be provided by ESO.}}}


% \subsection{Data Organization}
% \label{sec:dataorganization}

% \red{\textit{Outline of how to organize \instrument{} data, i.e. how to get to
%     a correct SOF file, which classification tags are accepted by the recipes
%     and how they are defined in terms of header keywords.}}

