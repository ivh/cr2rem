\section{\label{data_reduction}Data Reduction}

In this section, after an overview of the main problems the data reduction 
needs to solve, we list the required data and the recipes which allow to 
solve them, giving the data reduction sequence necessary to reduce calibration 
and science data. 

\subsection{Data reduction overview}
The principle of integral field spectroscopy is described by 
figure \ref{ifs_principle}. A two-dimensional image of the sky is 
separated by an image slicer into several components. Those are then  
aligned on a slit and dispersed to separate its spectral information
and then imaged on a detector. 
The main \instname\, data reduction problems to solve are the following.

\begin{itemize}
\item Correct for the detector signature: bad pixels, detector contribution 
to the measured signal, flat fielding (correct pixel to pixel gain variations 
and relative slitlet throughput differences), correct geometric distortions.
\item Perform the wavelength calibration.
\item Reconstruct the image FOV from the 32 image slices in a format which 
contains both the spatial and the spectral information.
\item Devise proper calibrations and observations to be able to properly 
correct the emission from the sky, from the instrument and from the telescope 
which are very strong in the NIR.
This requires to take sky frames together with the object frames in the night 
observations, daily calibrations with the flat lamp switched on and off, and 
possibly dark frames.

\end{itemize}
\begin{figure}[ht]
\begin{center}
\begin{tabular}{c}
%{\psfig{figure=ifs_principle.ps,width=12truecm}} \\
\end{tabular}
\end{center}
\caption{\label{ifs_principle}Integral Field Spectroscopy data reduction 
principle}
\end{figure}

In the following description we also indicate in parenthesis for each frame 
the corresponding PRO.CATG.
To locate the detector bad pixels one uses a bad pixel map. A master bad 
pixel map resulting from the combination of a set of (different) bad pixel 
maps is generated by the master flat recipe. 
First of all, as the detector is known to have construction defects, these 
will be indicated by a reference bad pixel map (REF\_BP\_MAP).
Hot pixels will be determined on dark frames (BP\_MAP\_HP). 
Non-linear response pixels are instead indicated by a bad pixel map 
(BP\_MAP\_NL) obtained by evaluating the pixel response of a set of flat 
exposures of increasing intensity. 
Other bad pixels (BP\_MAP\_NO) are determined on a set of flat fields (on 
the master flat field).\\
A master flat field (MASTER\_FLAT\_LAMP)
%, per dithered position) 
generated from a set of raw flat 
fields, is used to correct the   different detector pixel sensitivities.
It is known that the image sliced and projected on the detector is affected 
by distortions.
The si\_rec\_distortion recipe computes the distortions (DISTORTION) and 
the slitlet distances (SLITLETS\_DISTANCE). It uses a set of raw frames 
where only the first column of each slitlet is illuminated through fibres. 
In addition flats and arcs are taken within the north south template as 
required to reduce the data.
%As it is possible to use only a limited number of fibres per exposure are 
%necessary several exposures to cover all the slitlets. To get a synthetic 
%on frame with all the slitlets illuminated and a corresponding off frame 
%one need to properly combine the set of fibre flat field frames.
%This is done with a procedure which co-add the frames without pixel removal 
%or cutting off all pixel intensities above 0.2 of the maximum to respectively 
%get a fake on and a fake off frames.
%Then the fake off frame is subtracted to the fake on frame and after flat 
%field and bad pixel correction the distortions are determined.
%The the on-off fake frame is corrected for distortions and the slitlets 
%distances are computed running a north-south test.\\
A set of ``on'' and ``off'' arc lamp frames, a reference line table, a master 
flat field, the optical distortions map and a good guess of the slitlet 
positions are input of the wavecal recipe.  This recipe determines a 
wavelength map and obtains a better computation of the left edge position 
of each slitlet.\\

Science (or PSF or telluric standard) frames are corrected for sky background, 
flat field, distortions, and calibrated in wavelength. 
The sorted slitlets are then stacked in a cube, taking into account the 
relative distances of the position of the edge of each slitlet to 
the one of the first slitlet, 
with a final image realignment to get sub pixel accuracy.
The final product is thus a 3D data cube where the full spatial information 
is stored along the X and Y directions, and the wavelength information is 
stored along the Z direction. Each plane of the cube is a monochromatic 
reconstruction of the \instname\, FOV.

The north south test template traces each of the 32 slitlets by only one 
fibre exposure; therefore non linearities of the image scale within the 64 
pixel of a single slitlets are currently not corrected and could cause minor 
slice to slit ripples in the reconstructed cube.

\subsection{Required input data}
To be able to reduce science data one needs to use raw, product data and 
pipeline recipes in a given sequence which provides all the input necessary 
to each pipeline recipe. We call this sequence a data reduction cascade. 
The \instname\, data reduction cascade involves the following input data:
\begin{itemize}
\item Reference files:
\begin{itemize}
\item A reference bad pixel map, indicating known detector defects.
\item A list of arc lamp emission lines containing vacuum wavelengths and 
predicted intensities for wavelength calibration.
\item The DRS\_SETUP\_WAVE table as input of si\_rec\_distortion and 
      si\_rec\_wavecal to specify parameter peculiar of the wavelength 
      calibration algorithm.
\item A constant position assumed for the first column.
\end{itemize}
\item Raw frames:
\begin{itemize}
\item Linearity flat frames, to determine a map of non linear bad pixels. 
\item Darks, to determine master darks.
\item Flat fields, to determine master flats. 
\item Fibre frames, to trace the first column of each slitlet and, using also 
on/off lamp flats and arc lamp frames, to compute the optical distortions 
and slitlet distances.
\item Arc lamps, to perform the wavelength calibration.
\item Sky frames, to evaluate and subtract the strong and time-variable NIR 
sky emission.
\item Telluric STD star frames, to correct telluric absorption features.
\item PSF standards, to evaluate the strehl.
\item Science frames, to finally do science.
\end{itemize}
\item Calibration data products.
\begin{itemize}
\item Bad pixel maps, to correct for the detector defects.
\item Distortion coefficients, to correct for the optical distortions.
\item Master flats, to correct for different detector pixel efficiencies.
\item Master darks, to correct for the instrument bias if no off or sky 
frames are available.
\item Slitlet distances, to be able to properly reconstruct a cube.
\item Slitlets' left edge positions, to be able to properly reconstruct a cube.
\item Wavelength maps, to obtain a cube calibrated in wavelength.
\end{itemize}
\end{itemize}
Calibration data products can be generated from raw data using the pipeline 
recipes. Alternatively the user may use calibration products obtained from 
the ESO archive or from the ESO Data Flow Operation department.
Master bad pixel maps, the bad pixel maps coming from the standard flats, 
the master flats, the slitlets position table, the wavelength map depend 
from the observed band and instrument's pre-optic. Bad pixel maps coming 
from the non linearity test, distortion tables, slitlet distances, reference 
line tables depend only on the observed band. The first column table, the 
reference bad pixel map, and master darks depend neither from the 
band nor the pre-optic. Science data requiring master dark need to have 
matching values of the FITS keyword HIERARCH ESO DET DIT.



\subsection{Reduction cascade} 


The \instname\, data reduction follows the following sequence. A short 
description of the available recipes is given in section \ref{RECIPES}.
In parenthesis we provide the value of the DO category corresponding to each 
frame.

\putgraph{16}{girassocmap.png}{ASSOCMAP}{\instname\, Association Map}                        

\begin{itemize}
\item Run {\bf si\_rec\_detlin} on a set of flats with increasing 
intensity (LINEARITY\_LAMP) to determine the non linearity pixels bad pixel 
map (BP\_MAP\_NL).



\item Run {\bf si\_rec\_mdark} on a set of raw darks (DARK) to determine 
the master dark (MASTER\_DARK) and the hot pixels bad pixel map (BP\_MAP\_HP).
This map depends on DIT.

\item Run {\bf si\_rec\_mflat} on a set of standard flat fields (FLAT\_LAMP), 
the BP\_MAP\_NL and the REF\_BP\_MAP to determine the master bad pixel map 
(MASTER\_BP\_MAP) and the master lamp flat (MASTER\_FLAT\_LAMP).

\item Run {\bf si\_rec\_distortion} on a set of fibre flats (FIBRE\_NS), 
on/off arc lamps (WAVE\_NS) and on/off lamp flats (FLAT\_NS), using a 
reference line table (REF\_LINE\_ARC) to determine the optical distortions 
(DISTORTION) and the slitlet distances (SLITLET\_DISTANCES).
To set a few data reduction parameters which depends from the observed 
band and used instrument pre-optics the user has also to provide in input 
a DRS\_SETUP\_WAVE table frame.



\item Run {\bf si\_rec\_wavecal} on a set of arc lamp frames (FLAT\_WAVE), 
a MASTER\_BP\_MAP, \\ 
a MASTER\_FLAT\_LAMP, a DISTORTION, and a REF\_LINE\_ARC 
to determine the wavelength map (WAVE\_MAP) and the slitlet edge position 
table (SLIT\_POS). To set a few data reduction parameters which depends 
from the observed band and used instrument pre-optics the user has also 
to provide in input a DRS\_SETUP\_WAVE table. If the parameter 
{\bf wcal-slitpos\_bootstrap} has value set to FALSE, as we suggest for 
robustness, the user need to provide in input also an appropriate 
SLIT\_POS table, for example the one we provide as part of dtata reduction kit.

\item Run {\bf si\_rec\_psf} on PSF standards and  a MASTER\_BP\_MAP, 
a MASTER\_FLAT\_LAMP, a DISTORTION, a SLITLET\_DISTANCES, a SLIT\_POS and 
a WAVE\_MAP, to reduce the PSF standard and get information on the 
instrument's strehl.

\item Run {\bf si\_rec\_stdstar} on a reference telluric standard (STD) 
and a MASTER\_BP\_MAP, \\
 a MASTER\_FLAT\_LAMP, a DISTORTION, a SLITLET\_DISTANCES, and a SLIT\_POS and 
WAVE\_MAP, to reduce the telluric standards and get information on the 
instrument's response.

\item Run {\bf si\_rec\_objnod} on your scientific data (OBJECT\_NODDING) 
and a MASTER\_BP\_MAP, \\
a MASTER\_FLAT\_LAMP, a DISTORTION, a SLITLET\_DISTANCES, a 
SLIT\_POS and a WAVE\_MAP to reduce science data.
\end{itemize}



The main data products involved in the data reduction cascade are indicated 
in the \instname\, association map shown in Figure \ref{fig:ASSOCMAP}. It summarise 
dependencies between raw data, calibration products and recipes involved in 
the correction of the instrument signature and reduction of science data. 
Examples of set of frames input for each recipe are provided in section 
\ref{pipeline_recipe_interfaces}.



%\subsection{Set of frames}
%\label{SOF}

%Each pipeline recipe takes as input a set of input FITS data files. The 
%filenames are listed together with their DO category in an ASCII file, 
%the \ {\it Set of Frames} \ (SOF), that is required when launching a recipe.
%SOF files containing the frames selected by the user are automatically 
%created by \ {\it Gasgano} [14].

%Here is an example of SOF, valid for the \ {\it si\_rec\_wavecal} \ recipe:

%\begin{verbatim}
%    /file_path/SINFO.2004-08-14T10:20:56.497.fits  WAVE_LAMP
%    /file_path/SINFO.2004-08-14T10:22:44.285.fits  WAVE_LAMP
%    /file_path/xenon.tfits                         REF_LINE_ARC
%    /file_path/MASTER_BP_MAP_H_250.fits            MASTER_BP_MAP
%    /file_path/MASTER_LAMP_FLAT_H_250.fits         MASTER_FLAT_LAMP
%    /file_path/DISTORTION_H.fits                   DISTORTION
%    /file_path/DRS_SETUP_WAVE.fits                 DRS_SETUP_WAVE
%\end{verbatim}

%It contains the full path file name and its identifying tag (DO 
%classification for raw data and PRO.CATG for products).
%The user needs to create a set of frames ASCII file for each of the recipe 
%when esorex is being used.
%It is left to the user to make sure that the file listed exist and that the 
%corresponding tag is set in the set of frames and is appropriate.
%Using \ {\it Gasgano} [14] \ as an interface to the pipeline recipes the 
%classification of the data is automatically done.

%A recipe handling an incorrect SOF may stop in an unpredictable manner. 
%In the worst cases, the recipe would apparently run without any problem, 
%producing results that may look reasonable but are actually flawed.





    


