
\section{Pipeline Recipes Interfaces} 

\subsection{vmdet}
\label{sec:UVMDET}

The <<IIInstrument>> pipeline recipe \ {\it vmdet} \ is used to estimate the 
\ {\it read-out-noise} (RON) and the gain of the CCD, and to 
determine the positions of the bad pixels.

The input SOF should contain at least five pairs of flat field exposures,
all belonging to the same quadrant, each pair corresponding to a different 
exposure time. The flat fields can be produced either in imaging 
or in MOS mode. In MOS mode a HR grism is used, in order to 
illuminate the CCD also beyond the central region used in direct 
imaging mode, but no mask is inserted at the telescope focal plane. 
This type of exposure cannot really be considered a \ {\it spectral} 
\ flat field, because the CCD is exposed to ``white'' light ({\it i.e.}, 
without a wavelength dependency along the dispersion direction). The flat 
fields generated for the purpose of determining the detector properties 
(produced by the technical templates \ {\tt <<IIInstrument>>\_img\_tec\_DetLin} 
\ and \ {\tt <<IIInstrument>>\_mos\_tec\_DetLin}) \ are assigned the DO category 
\ {\tt DETECTOR\_PROPERTIES}, \ to distinguish them from the more common 
\ {\tt IMG\_SCREEN\_FLAT} \ or \ {\tt MOS\_SCREEN\_FLAT} \ that are 
used to produce master calibrations.

All the files that must be included in the input SOF are listed in table 
\ref{tab:IVMDET}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|c|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmdet input files} \\
    \hline
      {\bf DO category} & {\bf Type} & {\bf Explanation} & {\bf Required} \\
    \hline 
      DETECTOR\_PROPERTIES   & Raw frame   & Flat field exposure   & $\surd$ \\
      MASTER\_BIAS           & Calibration & Master bias           & $\surd$ \\
    \hline
    \end{tabular}
    \caption{\it Input files for the vmdet recipe.}
    \label{tab:IVMDET}
  \end{center}
\end{table}

The products of the \ {\it vmdet} \ recipe are shown in Table
\ref{tab:PVMDET}. Only the primary product, the bad pixel table, is copied 
(or moved) to the product directory.
Other products are generated only on request
(typically for debug purposes) and are not assigned a DO category as
they would not be used anywhere in further data processing steps.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmdet output files} \\
    \hline
      {\bf File name} & {\bf DO category} & {\bf Type} & {\bf Explanation} \\
    \hline
      ccd\_table.tfits & CCD\_TABLE & FITS & Bad pixel table \\
      bad\_pixel\_map.fits  & & FITS & Bad pixel image \\
      error\_image.fits     & & FITS & Error image \\
    \hline
    \end{tabular}
    \caption{\it Products of the vmdet recipe.}
    \label{tab:PVMDET}
  \end{center}
\end{table}

The \ {\it vmdet} \ parameters are listed in Table \ref{tab:CVMDET}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmdet configuration file} \\
    \hline
      {\bf Parameter} & {\bf Possible values} & {\bf Explanation} \\
    \hline 
      \tcen{DetectionMode} & Intolerant & All pixels with anomalous response are bad \\
                           & Tolerant & Only non-linear pixels are bad \\
    \hline
      DetectionThreshold & {\it float} (sigma) & Tolerance on bad pixel detection \\
    \hline
      \tcen{CreateBadPixelMap} & true & Create a bad pixel image \\
                               & false & Do not create it \\
    \hline
      \tcen{CreateErrorImage} & true & Create an error image \\
                              & false & Do not create it \\
    \hline
    \end{tabular}
    \caption{\it vmdet parameters.}
    \label{tab:CVMDET}
  \end{center}
\end{table}

A more complete description of the parameters meaning is also given:

\begin{description}

\item [CreateBadPixelMap:]  If this parameter is set, a
                        bad pixel image reflecting the content of the
                        created bad pixel table is created. This may
                        be useful for determining the optimal settings
                        for the parameters \ {\it DetectionMode} \ and 
                        \ {\it DetectionThreshold}, \ viewing the frequency
                        of ``bad'' pixels and their spatial distribution.

\item [CreateErrorImage:]  If this parameter is set an error image is 
                        created. The error image contains the values
                        of the RMS of the residuals for each linear
                        fitting done for bad pixel detection.

\item [DetectionMode:]  Method used for detecting bad pixels.
                        Possible settings are:

\begin{description}

  \item [Intolerant:]   A pixel is flagged as ``bad'' when the slope of 
                        the linear fit of each image median exposure level 
                        versus the corresponding pixel values deviates from 
                        the local average of all slopes by more than the 
                        threshold specified in \ {\it DetectionThreshold}.

  \item [Tolerant:]     The same method as in the ``{\it Intolerant}''
                        \ {\it DetectionMode} \ is applied, but before
                        linear fitting the measured pixel values are normalised
                        so that the maximum pixel value is equal to the
                        maximum median exposure level. 

\end{description}

\item [DetectionThreshold:] Number of standard deviations from the mean 
                        slope of the CCD response, that are necessary for 
                        classifying a pixel as ``bad''. 

\end{description}

A description of the algorithms used in this recipe is given in Section
\ref{AVMDET}, page \pageref{AVMDET}.

\subsection{vmbias}
\label{sec:UVMBIAS}

The <<IIInstrument>> pipeline recipe \ {\it vmbias} \ is used to create a master 
bias frame from a set of raw bias frames. All the files that must be 
included in the input SOF are listed in Table \ref{tab:IVMBIAS}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|c|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmbias input files} \\
    \hline
      {\bf DO category} & {\bf Type} & {\bf Explanation} & {\bf Required} \\
    \hline 
      BIAS            & Raw frame   & Bias exposure         & $\surd$ \\
      CCD\_TABLE      & Calibration & Bad pixel table       &         \\
%      MASTER\_BIAS    & Calibration & Reference master bias &         \\
    \hline
    \end{tabular}
    \caption{\it Input files for the vmbias recipe.}
    \label{tab:IVMBIAS}
  \end{center}
\end{table}

A bad pixel table needs to be specified only if the cleaning of bad
pixels is requested. In the calibration directories there is one
CCD\_TABLE file for each quadrant, named \ {\tt badpixel.}$q${\tt .tfits}
(where $q$ is the quadrant number). Care should be taken in selecting
the appropriate bad pixel tables for imaging and spectral instrument
modes, that have the same names but are located in separated directories.

The only product of the \ {\it vmbias} \ recipe is the master bias, as 
shown in Table \ref{PVMBIAS}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmbias output files} \\
    \hline
      {\bf File name} & {\bf DO category} & {\bf Type} & {\bf Explanation} \\
    \hline
      master\_bias.fits &  MASTER\_BIAS & FITS & Master bias \\
    \hline
    \end{tabular}
    \caption{\it Product of the vmbias recipe.}
    \label{tab:PVMBIAS}
  \end{center}
\end{table}

The \ {\it vmbias} \ parameters are described in Table \ref{CVMBIAS}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmbias configuration file} \\
    \hline
      {\bf Parameter} & {\bf Possible values} & {\bf Explanation} \\
    \hline 
      \tcen{AllowSingleFrames} & true & A single input bias is also allowed\\
                               & false & More than one input bias is required \\
    \hline
                         & Average & Master bias is average of input biases \\
                         & Median  & Master bias is median of input biases \\
             StackMethod & MinMax  & Master bias is obtained with min-max rejection\\
                         & Ksigma  & Master bias is obtained with K-sigma clipping\\
                         & Auto    & Optimal combination of input biases \\
    \hline
             MinRejection & {\it int} & No. of lowest rejected values for rejection method \\
    \hline
             MaxRejection & {\it int} & No. of highest rejected values for rejection method \\
    \hline
             KSigmaLow & {\it float} (sigma) & Low threshold for K-sigma clipping method \\
    \hline
             KSigmaHigh & {\it float} (sigma) & High threshold for K-sigma clipping method \\
%    \hline
%             \tcen{ValidateFrames} & true & Run consistency check on raw bias frames \\
%                            & false & Skip consistency check on raw bias frames \\
%    \hline
%             LevelTolerance & {\it float} (sigma) & Threshold for level consistency \\
%             PatternTolerance & {\it float} (sigma) & Threshold for flux pattern consistency \\
    \hline
             \tcen{RemoveOverscan} & true & Remove overscan regions from master bias \\
                            & false & Keep overscan regions in master bias \\
    \hline
             \tcen{CleanBadPixel}  & true & Interpolate bad pixels on master bias \\
                            & false & No bad pixel correction \\
    \hline
             \tcen{CleanCosmic}    & true & Remove cosmic ray events from each bias \\
                            & false & No cosmic ray removal \\
    \hline
             \tcen{ComputeQC} & true & Compute QC parameters \\
                         & false & Do not compute QC parameters \\
%    \hline
%             \tcen{ApplyQC}     & true & Quality control of master bias \\
%                         & false & Skip quality control of master bias \\
%    \hline
%             MaxDeviation & {\it float} (sigma) & Allowed deviation from nominal bias level \\
    \hline
    \end{tabular}
    \caption{\it vmbias parameters.}
    \label{tab:CVMBIAS}
  \end{center}
\end{table}

A more complete description of the parameters meaning is also given:

\begin{description}

\item [AllowSingleFrames:]  If this parameter is set, then a master bias
                        is produced also from a single input bias.
                        In this case the \ {\it StackMethod} \ is ignored.

%\item [ApplyQC:] If this parameter is set, the product master bias
%                 is compared with a reference master bias that must
%                 be specified in the input SOF (see Table \ref{tab:IVMBIAS}).
%                 The median level of the master bias is compared with 
%                 the nominal bias value taken from the header of the 
%                 reference master bias. If the offset from the nominal 
%                 level is larger than the value specified by 
%                 {\it MaxDeviation} a warning is issued. If the product
%                 master bias meets the quality control criterion the 
%                 header keyword \ {\tt PRO BIAS DIFF} \ is set to the 
%                 difference between the master bias median level and 
%                 its nominal value.

\item [CleanBadPixel:]  Bad pixel correction on the master bias.
                        If this option is turned on, a bad pixel
                        table should be specified in the input SOF
                        (see Table \ref{tab:IVMBIAS}). The bad pixel
                        correction algorithm is described in Section
                        \ref{sec:ABADPIX}, page \pageref{sec:ABADPIX}.

\item [CleanCosmic:]    Cosmic ray events removal from each input bias.
                        The cosmic ray rejection algorithm is described 
                        in Section \ref{sec:ACOSMIC}, page \pageref{sec:ACOSMIC}.

\item [ComputeQC:]      If this parameter is set, \ {\it Quality Control}
                        \ (QC) parameters will be computed and written to 
                        the header of the output master bias and to an 
                        output QC PAF file named \ {\tt qc0000.paf}. 
                        \ This file is not classified as a pipeline recipe 
                        product, as it is an intermediate dataset 
                        that in the standard pipeline operations would 
                        be translated into new entries in the QC log file. 
                        Currently the QC parameters computed by 
                        \ {\it vmbias} \ are:

\begin{description}

\item {\tt QC BIAS MEAN:} Mean value of the 1600x1800 central pixels of 
                   the first raw bias listed in the SOF.
\item {\tt QC BIAS MEDIAN:} Median value of the 1600x1800 central pixels 
                   of the first raw bias listed in the SOF. 
\item {\tt QC BIAS RMS:} The population standard deviation of the 1600x1800 
                   central pixels of the first input bias.
\item {\tt QC RON:} Population standard deviation of the 1600x1800 central
                   pixels of the difference between the first and the second
                   raw biases listed in the SOF, divided by \ $\sqrt{2}$.
\item {\tt QC BIAS FPN:} The population standard deviation of the 1600x1800 
                   central pixels of the difference between the first raw 
                   bias and the second raw bias shifted by 10x10 pixels, 
                   is computed. This is the combination of fixed-pattern-noise 
                   and read-out-noise (scaled by \ $\sqrt{2}$). 
                   The read-out-noise contribution \ ({\tt QC RON}) \ is 
                   then quadratically subtracted from the total noise.
\item {\tt QC BIAS STRUCT:} The population standard deviation of the 
                   1600x1800 central pixels of the first raw bias 
                   \ ({\tt QC BIAS RMS}) \ is the combination of structure, 
                   fixed-pattern-noise, and read-out-noise. 
                   The read-out-noise \ ({\tt QC RON}) \ and the 
                   fixed-pattern-noise \ ({\tt QC BIAS FPN}) \ 
                   contributions are quadratically subtracted from this value.
\item {\tt QC BIAS MASTER MEAN:} Mean value of the 1600x1800 central pixels 
                   of the product master bias.
\item {\tt QC BIAS MASTER MEDIAN:} Median value of the 1600x1800 central 
                   pixels of the product master bias.
\item {\tt QC BIAS MASTER RMS:} Population standard deviation of all the
                   1600x1800 central pixel values of the product master bias.
\item {\tt QC BIAS MASTER NOISE:} The expected noise is computed as the 
                   value of \ {\tt QC RON}, \ divided by the square root of 
                   the number of raw bias frames used in the construction 
                   of the master bias.
                   Next, the population standard deviation of the 1600x1800
                   central pixel values of the master bias is determined,
                   excluding from the computation all values differing
                   from \ {\tt QC BIAS MASTER MEDIAN} \ more than three times 
                   the expected noise.
\item {\tt QC BIAS MASTER FPN:} The population standard deviation of 
                   the difference
                   between the central 1600x1800 pixels of the master
                   bias, and the region of the master bias shifted
                   10x10 pixels from the central one, is computed.
                   This is the combination of fixed-pattern-noise and
                   white noise (scaled by \ $\sqrt{2}$). The white-noise
                   contribution \ ({\tt QC BIAS MASTER NOISE}) \ is then 
                   quadratically subtracted from the total noise.
\item {\tt QC BIAS MASTER STRUCT:} The population standard deviation of 
                   the 1600x1800
                   central pixels of the master bias is computed. This
                   is the combination of structure, fixed-pattern-noise,
                   and white-noise. The white-noise 
                   \ ({\tt QC BIAS MASTER NOISE}) \ and the fixed-pattern-noise
                   \ ({\tt QC BIAS MASTER FPN}) \ contributions are then 
                   quadratically subtracted.

\end{description}

\item [KSigmaHigh:]  Number of standard deviations above the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

\item [KSigmaLow:]  Number of standard deviations below the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

%                          
% \item [LevelTolerance:]  The median of the median levels from each bias
%                          is found, and the standard deviation from this
%                          median is evaluated. Any bias having a median
%                          level beyond the number of standard deviations
%                          specified by this parameter is rejected from the
%                          creation of the master bias. This parameter is 
%                          effective only if \ {\it ValidateFrames} \ is set.
%
%\item [MaxDeviation:] Number of population standard deviations of 
%                    the master bias pixel values, to be used in the
%                    quality control triggered by parameter \ {\it ApplyQC}.

\item [MaxRejection:]  Number of highest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.

\item [MinRejection:]  Number of lowest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.
%                          
% \item [PatternTolerance:]  The difference of any bias with all the other
%                          biases is computed, and the expected noise is
%                          estimated. Any difference image having a median
%                          level differing from zero more than the expected 
%                          noise times the value specified by this parameter
%                          is flagged. Any bias not consistent with all the
%                          others is rejected from the creation of the master 
%                          bias. This parameter is effective only if
%                          \ {\it ValidateFrames} \ is set.

\item [RemoveOverscan:] When this parameter is set, the overscan regions are
                        removed from the product master bias.

\item [StackMethod:]  Combination method of input biases for master bias 
                      creation. See Section \ref{ACOMB} for a complete 
                      description of all the combination methods. Possible 
                      settings are:

\begin{description}

  \item [Auto:]     Given the number of input biases, an optimal bias
                    combination method is selected. Currently this is
                    always going to the method \ {\it ``Average''}.

  \item [Average:]  The master bias is the mean of the input frames.

  \item [Ksigma:]   The master bias is the mean of the input frames, after
                    K-sigma screening of pixel values. The number of sigma 
                    to be applied in the rejection is specified by the 
                    parameters \ {\it KSigmaLow} \ and \ {\it KSigmaHigh}.

  \item [Median:]   The master bias is the median of the input frames.

  \item [MinMax:]   The master bias is the mean of the input frames, after
                    rejection of minimum and maximum values.
                    The number of values to reject is specified by the 
                    parameters \ {\it MinRejection} \ and \ {\it MaxRejection}.

\end{description}

% \item [ValidateFrames:]  If this option is set, a consistency check is run 
%                          on the input raw biases. The median levels and the
%                          signal patterns of each bias are compared. Any
%                          bias exceeding the thresholds specified by the
%                          parameters \ {\it LevelTolerance} \ and 
%                          \ {\it PatternTolerance} \ is rejected from the
%                          creation of the master bias. 

\end{description}

A description of the algorithms used in this recipe is given in Section
\ref{AVMBIAS}, page \pageref{AVMBIAS}.


\subsection{vmdark}
\label{sec:UVMDARK}

The <<IIInstrument>> pipeline recipe \ {\it vmdark} \ is used to create a master 
dark frame from a set of raw dark frames. All the files that must be 
included in the input SOF are listed in Table \ref{tab:IVMDARK}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|c|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmdark input files} \\
    \hline
      {\bf DO category} & {\bf Type} & {\bf Explanation} & {\bf Required} \\
    \hline 
      DARK            & Raw frame   & Dark exposure         & $\surd$ \\
      MASTER\_BIAS    & Calibration & Master bias           & $\surd$ \\
      CCD\_TABLE      & Calibration & Bad pixel table       &         \\
%      MASTER\_DARK    & Calibration & Reference master dark &         \\
    \hline
    \end{tabular}
    \caption{\it Input files for the vmdark recipe.}
    \label{tab:IVMDARK}
  \end{center}
\end{table}

A bad pixel table needs to be specified only if the cleaning of bad
pixels is requested. In the calibration directories there is one
CCD\_TABLE file for each quadrant, named \ {\tt badpixel.}$q${\tt .tfits}
(where $q$ is the quadrant number). Care should be taken in selecting
the appropriate bad pixel tables for imaging and spectral instrument
modes, that have the same names but are located in separated directories.

The only product of the \ {\it vmdark} \ recipe is the master dark, as 
shown in Table \ref{PVMDARK}. 

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmdark output files} \\
    \hline
      {\bf File name} & {\bf DO category} & {\bf Type} & {\bf Explanation} \\
    \hline
      master\_dark.fits &  MASTER\_DARK & FITS & Master dark \\
    \hline
    \end{tabular}
    \caption{\it Product of the vmdark recipe.}
    \label{tab:PVMDARK}
  \end{center}
\end{table}

The \ {\it vmdark} \ parameters are listed in Table \ref{CVMDARK}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmdark configuration file} \\
    \hline
      {\bf Parameter} & {\bf Possible values} & {\bf Explanation} \\
    \hline 
             \tcen{AllowSingleFrames} & true & A single input dark is also allowed\\
                        & false & More than one input dark is required \\
    \hline
                         & Average & Master dark is average of input darks \\
                         & Median  & Master dark is median of input darks \\
             StackMethod & MinMax  & Master dark is obtained with min-max rejection\\
                         & Ksigma  & Master dark is obtained with K-sigma clipping\\
                         & Auto    & Optimal combination of input darks \\
    \hline
             MinRejection & {\it int} & No. of lowest rejected values for rejection method \\
    \hline
             MaxRejection & {\it int} & No. of highest rejected values for rejection method \\
    \hline
             KSigmaLow & {\it float} (sigma) & Low threshold for K-sigma clipping method \\
    \hline
             KSigmaHigh & {\it float} (sigma) & High threshold for K-sigma clipping method \\
%    \hline
%             \tcen{ValidateFrames} & true & Run consistency check on raw dark frames \\
%                            & false & Skip consistency check on raw dark frames \\
%    \hline
%             LevelTolerance & {\it float} (sigma) & Threshold for level consistency \\
%             PatternTolerance & {\it float} (sigma) & Threshold for flux pattern consistency \\
    \hline
             \tcen{BiasMethod} & Master & Bias removal with no overscan correction \\
                        & Zmaster & Bias removal with overscan correction \\
    \hline
             \tcen{CleanBadPixel}  & true & Interpolate bad pixels on master dark \\
                            & false & No bad pixel correction \\
    \hline
             \tcen{CleanCosmic}    & true & Remove cosmic ray events from each dark \\
                            & false & No cosmic ray removal \\
    \hline
             CosmicThreshold & {\it float} & Sigmas above level discriminator \\
    \hline
             CosmicRatio & {\it float} & Peak/neighbours discriminator \\
    \hline
             \tcen{ComputeQC} & true & Compute QC parameters \\
                         & false & Do not compute QC parameters \\
%    \hline
%             \tcen{ApplyQC}     & true & Quality control of master dark \\
%                         & false & Skip quality control of master dark \\
%    \hline
%             MaxDeviation & {\it float} (sigma) & Allowed deviation from nominal bias level \\
    \hline
    \end{tabular}
    \caption{\it vmdark parameters.}
    \label{tab:CVMDARK}
  \end{center}
\end{table}

A more complete description of the parameters meaning is also given:

\begin{description}

\item [AllowSingleFrames:]  If this parameter is set, then a master dark
                        is produced also from a single input dark frame.
                        In that case the \ {\it StackMethod} \ is ignored.

%\item [ApplyQC:] If this parameter is set, the product master dark
%                 is compared with a reference master dark that must
%                 be specified in the input SOF (see Table \ref{tab:IVMDARK}).
%                 The median level of the master dark is compared with 
%                 the nominal dark value taken from the header of the 
%                 reference master dark. If the offset from the nominal 
%                 level is larger than the value specified by 
%                 {\it MaxDeviation} a warning is issued. If the product
%                 master dark meets the quality control criterion the 
%                 header keyword {\tt PRO DARK DIFF} \ is set to the 
%                 difference between the master dark median level and 
%                 its nominal value.

\item [BiasMethod:]     Method for bias removal from the input dark frames.
                        The bias removal procedure is described in some
                        detail in Section \ref{ABIAS}. Possible settings are:

\begin{description}
  \item [Master:]       After master bias subtraction, prescan and
                        overscan regions are trimmed away from the
                        dark frame.

  \item [Zmaster:]      After master bias subtraction the overscan correction
                        is applied before trimming away the overscan regions.
\end{description}

\item [CleanBadPixel:]  Bad pixel correction on the master dark.
                        If this option is turned on, a bad pixel
                        table should be specified in the input SOF
                        (see Table \ref{tab:IVMDARK}). The bad pixel
                        correction algorithm is described in Section
                        \ref{sec:ABADPIX}, page \pageref{sec:ABADPIX}.

\item [CleanCosmic:]    Cosmic ray events removal from each input dark.
                        The cosmic ray rejection algorithm is described 
                        in Section \ref{sec:ACOSMIC}, page \pageref{sec:ACOSMIC}.

\item [ComputeQC:]      If this parameter is set, \ {\it Quality Control}
                        \ (QC) parameters will be computed and written to 
                        the header of the output master dark and to an 
                        output QC PAF file named \ {\tt qc0000.paf}. 
                        \ This file is not classified as a pipeline recipe 
                        product, as it is an intermediate dataset 
                        that in the standard pipeline operations would 
                        be translated into new entries in the QC log file. 
                        Currently the QC parameters computed by 
                        \ {\it vmdark} \ are:

\begin{description}

\item {\tt QC DARK MASTER MEAN:} Mean value of the 1600x1800 central 
                   pixels of the product master dark (ADU/s).
\item {\tt QC DARK MASTER RMS:} Population standard deviation of all 
                   1600x1800 central pixel values of the product master dark
                   (ADU/s).
\item {\tt QC DARK MASTER MEDIAN:} Median value of the 1600x1800 central 
                   pixels of the product master dark (ADU/s).
\item {\tt QC DARK CURRENT:} Simple conversion of 
                   \ {\tt QC DARK MASTER MEDIAN} \ into \ $e^-$/pixel/hour.
\item {\tt QC DARK CURRENT RMS:} Simple conversion of 
                   \ {\tt QC DARK CURRENT RMS} \ into \ $e^-$/pixel/hour.

\end{description}

\item [CosmicRatio:]    Critical ratio for discriminating between
                        objects and cosmic rays. This parameter is 
                        effective when \ {\it CleanCosmic} \ is set.

\item [CosmicThreshold:]  Threshold for the selection of cosmic rays
                        candidates. This parameter is effective when 
                        \ {\it CleanCosmic} \ is set.

\item [KSigmaLow:]  Number of standard deviations below the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

\item [KSigmaHigh:]  Number of standard deviations above the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.
%                          
% \item [LevelTolerance:]  The median of the median levels from each bias
%                          is found, and the standard deviation from this
%                          median is evaluated. Any bias having a median
%                          level beyond the number of standard deviations
%                          specified by this parameter is rejected from the
%                          creation of the master bias. This parameter is 
%                          effective only if \ {\it ValidateFrames} \ is set.
%
%\item [MaxDeviation:] Number of population standard deviations of 
%                    the master dark pixel values, to be used in the
%                    quality control triggered by parameter {\it ApplyQC}.

\item [MaxRejection:]  Number of highest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.

\item [MinRejection:]  Number of lowest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.
%                          
% \item [PatternTolerance:]  The difference of any bias with all the other
%                          biases is computed, and the expected noise is
%                          estimated. Any difference image having a median
%                          level differing from zero more than the expected 
%                          noise times the value specified by this parameter
%                          is flagged. Any bias not consistent with all the
%                          others is rejected from the creation of the master 
%                          bias. This parameter is 
%                          effective only if \ {\it ValidateFrames} \ is set.

\item [StackMethod:]  Combination method of input darks for master dark 
                      creation. See Section \ref{ACOMB} for a complete 
                      description of all the combination methods. Possible 
                      settings are:

\begin{description}

  \item [Auto:]     Given the number of input darks, an optimal dark
                    combination method is selected. Currently this is
                    always going to the method \ {\it ``Average''}.

  \item [Average:]  The master dark is the mean of the input frames.

  \item [Ksigma:]   The master dark is the mean of the input frames, after
                    K-sigma screening of pixel values. The number of sigma 
                    to be applied in the rejection is specified by the 
                    parameters \ {\it KSigmaLow} \ and \ {\it KSigmaHigh}.

  \item [Median:]   The master dark is the median of the input frames.

  \item [MinMax:]   The master dark is the mean of the input frames, after
                    rejection of minimum and maximum values.
                    The number of values to reject is specified by the 
                    parameters \ {\it MinRejection} \ and \ {\it MaxRejection}.

\end{description}

% \item [ValidateFrames:]  If this option is set, a consistency check is run 
%                          on the input raw biases. The median levels and the
%                          signal patterns of each bias are compared. Any
%                          bias exceeding the thresholds specified by the
%                          parameters {\it LevelTolerance} and 
%                          {\it PatternTolerance} is rejected from the
%                          creation of the master bias. 

\end{description}

A description of the algorithms used in this recipe is given in Section
\ref{AVMDARK}, page \pageref{AVMDARK}.


\subsection{vmimflatscreen}
\label{sec:UFLATSCREEN}

The <<IIInstrument>> pipeline recipe \ {\it vmimflatscreen} \ is used to create 
a master screen flat field from a set of raw screen flat fields.
The master screen flat field is not used directly in the flat field
correction of scientific data, but it is optionally used just in
the creation of a master sky flat field (see Section \ref{sec:UFLATSKY},
page \pageref{sec:UFLATSKY}).

All the files that must be included in the input SOF are listed in table 
\ref{tab:IFLATSCREEN}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|c|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmimflatscreen input files} \\
    \hline
      {\bf DO category} & {\bf Type} & {\bf Explanation} & {\bf Required} \\
    \hline 
      IMG\_SCREEN\_FLAT  & Raw frame   & Screen flat field exposure & $\surd$ \\
      MASTER\_BIAS    & Calibration & Master bias           & $\surd$ \\
      MASTER\_DARK    & Calibration & Master dark           &         \\
      CCD\_TABLE      & Calibration & Bad pixel table       &         \\
    \hline
    \end{tabular}
    \caption{\it Input files for the vmimflatscreen recipe.}
    \label{tab:IFLATSCREEN}
  \end{center}
\end{table}

A bad pixel table needs to be specified only if the cleaning of bad
pixels is requested. In the calibration directories there is one
CCD\_TABLE file for each quadrant, named \ {\tt badpixel.}$q${\tt .tfits}
(where $q$ is the quadrant number). Care should be taken in selecting
the appropriate bad pixel tables for imaging and spectral instrument
modes, that have the same names but are located in separated directories.

The primary product of the \ {\it vmimflatscreen} \ recipe is the normalised
master screen flat field, as shown in Table \ref{PFLATSCREEN}. 
A secondary product is the combined screen flat field, that is
the result of the combination of all inputs but without any
normalisation applied, and is just used for data quality control. 

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmimflatscreen output files} \\
    \hline
      {\bf File name} & {\bf DO category} & {\bf Type} & {\bf Explanation} \\
    \hline
      img\_master\_screen\_flat.fits &  IMG\_MASTER\_SCREEN\_FLAT & FITS & Master screen flat field \\
      img\_combined\_screen\_flat.fits &  IMG\_COMBINED\_SCREEN\_FLAT & FITS & Combined screen flat field \\
    \hline
    \end{tabular}
    \caption{\it Products of the vmimflatscreen recipe.}
    \label{tab:PFLATSCREEN}
  \end{center}
\end{table}

The \ {\it vmimflatscreen} \ parameters are listed in table 
\ref{CFLATSCREEN}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmimflatscreen configuration file} \\
    \hline
      {\bf Parameter} & {\bf Possible values} & {\bf Explanation} \\
    \hline 
             \tcen{AllowSingleFrames} & true & A single input flat field is also allowed\\
                        & false & More than one input flat field is required \\
    \hline
                         & Average & Combined flat field is average of inputs\\
                         & Median  & Combined flat field is median of inputs \\
             StackMethod & MinMax  & Combined flat field is obtained with min-max rejection\\
                         & Ksigma  & Combined flat field is obtained with K-sigma clipping\\
                         & Auto    & Optimal combination of input flat fields \\
    \hline
             MinRejection & {\it int} & No. of lowest rejected values for rejection method \\
    \hline
             MaxRejection & {\it int} & No. of highest rejected values for rejection method \\
    \hline
             KSigmaLow & {\it float} (sigma) & Low threshold for K-sigma clipping method \\
    \hline
             KSigmaHigh & {\it float} (sigma) & High threshold for K-sigma clipping method \\
%    \hline
%             \tcen{ValidateFrames} & true & Run consistency check on raw dark frames \\
%                            & false & Skip consistency check on raw dark frames \\
%    \hline
%             LevelTolerance & {\it float} (sigma) & Threshold for level consistency \\
%             PatternTolerance & {\it float} (sigma) & Threshold for flux pattern consistency \\
    \hline
              \tcen{BiasMethod} & Master & Bias removal with no overscan correction \\
                        & Zmaster & Bias removal with overscan correction \\
    \hline
             \tcen{CleanBadPixel}  & true & Interpolate bad pixels on product flat fields \\
                            & false & No bad pixel correction \\
    \hline
             \tcen{CleanCosmic}    & true & Remove cosmic ray events from each flat field \\
                            & false & No cosmic ray removal \\
    \hline
             CosmicThreshold & {\it float} & Sigmas above level discriminator \\
    \hline
             CosmicRatio & {\it float} & Peak/neighbours discriminator \\
    \hline
             SmoothBoxSize & {\it int} (pixel) & Size of smoothing running box\\
    \hline
             \tcen{SmoothMethod} & Median & Median of values in running box\\
                          & Average & Average of values in running box\\
    \hline
             \tcen{ComputeQC} & true & Compute QC parameters \\
                         & false & Do not compute QC parameters \\
    \hline
    \end{tabular}
    \caption{\it vmimflatscreen parameters.}
    \label{tab:CFLATSCREEN}
  \end{center}
\end{table}

A more complete description of the parameters meaning is also given:

\begin{description}

\item [AllowSingleFrames:]  If this parameter is set, then a master screen
                        flat field is produced also from a single input 
                        screen flat field frame.
                        In that case the \ {\it StackMethod} \ is ignored.

\item [BiasMethod:]     Method for bias removal from the input screen
                        flat field frames.
                        The bias removal procedure is described in some
                        detail in Section \ref{ABIAS}. Possible settings are:

\begin{description}
  \item [Master:]       After master bias subtraction, prescan and
                        overscan regions are trimmed away from the
                        flat field frame.

  \item [Zmaster:]      After master bias subtraction the overscan correction
                        is applied before trimming away the overscan regions.
\end{description}

\item [CleanBadPixel:]  Bad pixel correction on the products.
                        If this option is turned on, a bad pixel
                        table should be specified in the input SOF
                        (see Table \ref{IFLATSKY}). The bad pixel
                        correction algorithm is described in Section
                        \ref{sec:ABADPIX}, page \pageref{sec:ABADPIX}.

\item [CleanCosmic:]    Cosmic ray events removal from each input flat field.
                        The cosmic ray rejection algorithm is described 
                        in Section \ref{sec:ACOSMIC}, page \pageref{sec:ACOSMIC}.

\item [ComputeQC:]      If this parameter is set, \ {\it Quality Control}
                        \ (QC) parameters will be computed and written to 
                        the header of the output master screen flat field 
                        and to an 
                        output QC PAF file named \ {\tt qc0000.paf}. 
                        \ This file is not classified as a pipeline recipe 
                        product, as it is an intermediate dataset 
                        that in the standard pipeline operations would 
                        be translated into new entries in the QC log file. 
                        The QC parameters are computed only if the exposure 
                        time of the first two raw screen flat fields listed 
                        in the input SOF is the same (within 4\%).
                        Currently the QC parameters computed by 
                        \ {\it vmimflatscreen} \ are:

\begin{description}

\item {\tt QC CONAD:} Conversion factor from ADU to electrons ($e^-$/ADU). 
                   The difference frame of the first two raw screen flat
                   fields listed in the input SOF is computed. Then the 
                   1600x1800
                   central region of the image is divided into 16x18 100x100
                   boxes. For each one of these boxes, the median signal
                   level from the first raw frame is divided by the variance
                   in the difference frame scaled by 2. The median value of
                   the 16x18 values obtained is the accepted value for the
                   gain conversion factor.
\item {\tt QC CONAD RMS:} The rms of the 16x18 values obtained in the
                   determination of \ {\tt QC CONAD} \ is computed,
                   and divided by the square root of 16x18.
\item {\tt QC FLAT PHN:} Photon noise (in ADU). 
                   The standard deviation of the 1600x1800 pixel central 
                   region of the difference of the first two raw screen 
                   flat fields listed in the input SOF is computed and
                   then scaled by \ $\sqrt{2}$.
\item {\tt QC FLAT FPN:} Fixed pattern noise (in ADU).
                   The difference between the 1600x1800
                   central pixels of the first frame, and the same
                   region shifted by 10x10 pixels in the second frame,
                   is computed. The standard deviation of the signal 
                   is the combination of fixed pattern
                   noise and photon noise (scaled by \ $\sqrt{2}$). The photon
                   noise \ {\tt QC FLAT PHN} \ is then quadratically 
                   subtracted.
\item {\tt QC FLAT STRUCT:} Screen flat field structure (in ADU).
                   The population standard deviation of the
                   1600x1800 central pixels of the first flat field
                   in the input SOF is computed. This is the combination 
                   of structure, fixed pattern noise \ {\tt QC FLAT FPN}, \ 
                   and photon noise \ {\tt QC FLAT PHN}. \ The photon noise 
                   and the fixed pattern noise are then quadratically 
                   subtracted.
\item {\tt QC FLAT EFFICIENCY:} Signal per unit of exposure (in ADU/s).
                   The median level of the 1600x1800 central pixels of
                   the first input screen flat field is divided by its
                   exposure time.
\item {\tt QC FLAT MASTER MEDIAN:} Median value of the 1600x1800 central 
                   pixels of the combined screen flat field.
\item {\tt QC FLAT MASTER RMS:} Population standard deviation of the 
                   1600x1800 central pixels of the combined
                   screen flat field.

\end{description}

\item [CosmicRatio:]    Critical ratio for reducing the effect of variable
                        background on cosmic rays identification. This 
                        parameter is effective when \ {\it CleanCosmic} 
                        \ is set.

\item [CosmicThreshold:]  Threshold for the selection of cosmic rays
                        candidates. This parameter is effective when 
                        \ {\it CleanCosmic} \ is set.

\item [KSigmaHigh:]  Number of standard deviations above the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

\item [KSigmaLow:]  Number of standard deviations below the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

\item [MaxRejection:]  Number of highest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.

\item [MinRejection:]  Number of lowest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.

\item [SmoothBoxSize:] Length in pixel of the side of the square smoothing 
                       box used in the normalisation of the master flat
                       field.

\item [SmoothMethod:]  The smoothing method used in the normalisation of the
                       master flat field. Possible settings are:

\begin{description}

  \item [Average:] The central pixel within the smoothing running box
                  is replaced with the average of the values of the
                  pixels contained in the box.

  \item [Median:] The central pixel within the smoothing running box
                  is replaced with the median of the values of the
                  pixels contained in the box.

\end{description}

\item [StackMethod:]  Combination method of input screen flat fields for 
                      combined flat field 
                      creation. See Section \ref{ACOMB} for a complete 
                      description of all the combination methods. Possible 
                      settings are:

\begin{description}

  \item [Auto:]     Given the number of input screen flat fields, an optimal 
                    combination method is selected. Currently this is
                    always going to the method \ {\it ``Average''}.

  \item [Average:]  The combined screen flat field is the mean of the 
                    input frames.

  \item [Ksigma:]   The combined screen flat field is the mean of the 
                    input frames, after
                    K-sigma screening of pixel values. The number of sigma 
                    to be applied in the rejection is specified by the 
                    parameters \ {\it KSigmaLow} \ and \ {\it KSigmaHigh}.

  \item [Median:]   The combined screen flat field is the median of the 
                    input frames.

  \item [MinMax:]   The combined screen flat field is the mean of the 
                    input frames, after
                    rejection of minimum and maximum values.
                    The number of values to reject is specified by the 
                    parameters \ {\it MinRejection} \ and \ {\it MaxRejection}.

\end{description}

\end{description}

A description of the algorithms used in this recipe is given in Section
\ref{AFLATSCREEN}, page \pageref{AFLATSCREEN}.

\subsection{vmimflatsky}
\label{sec:UFLATSKY}

The <<IIInstrument>> pipeline recipe \ {\it vmimflatsky} \ is used to create 
a master sky flat field from a set of raw sky flat fields.
The master sky flat field is the dataset used for the flat field
correction of scientific data.

All the files that must be included in the input SOF are listed in table 
\ref{IFLATSKY}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|c|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmimflatsky input files} \\
    \hline
      {\bf DO category} & {\bf Type} & {\bf Explanation} & {\bf Required} \\
    \hline 
      IMG\_SKY\_FLAT  & Raw frame   & Sky flat field exposure & $\surd$ \\
      MASTER\_BIAS    & Calibration & Master bias           & $\surd$ \\
      MASTER\_DARK    & Calibration & Master dark           &         \\
      IMG\_MASTER\_SCREEN\_FLAT & Calibration & Master screen flat field & \\
      CCD\_TABLE      & Calibration & Bad pixel table       &         \\
    \hline
    \end{tabular}
    \caption{\it Input files for the vmimflatsky recipe.}
    \label{tab:IFLATSKY}
  \end{center}
\end{table}

A bad pixel table needs to be specified only if the cleaning of bad
pixels is requested. In the calibration directories there is one
CCD\_TABLE file for each quadrant, named \ {\tt badpixel.}$q${\tt .tfits}
(where $q$ is the quadrant number). Care should be taken in selecting
the appropriate bad pixel tables for imaging and spectral instrument
modes, that have the same names but are located in separated directories.

The only product of the \ {\it vmimflatsky} \ recipe is the normalised
master sky flat field, as shown in Table \ref{PFLATSKY}. 

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmimflatsky output files} \\
    \hline
      {\bf File name} & {\bf DO category} & {\bf Type} & {\bf Explanation} \\
    \hline
      img\_master\_sky\_flat.fits &  IMG\_MASTER\_SKY\_FLAT & FITS & Master sky flat field \\
    \hline
    \end{tabular}
    \caption{\it Products of the vmimflatsky recipe.}
    \label{tab:PFLATSKY}
  \end{center}
\end{table}

The \ {\it vmimflatsky} \ parameters are listed in table 
\ref{CFLATSKY}.

\begin{table}[h]
  \begin{center}
    \begin{tabular}{|l|l|l|}
%    \hline
%      \multicolumn{4}{|c|}{\bf vmimflatsky configuration file} \\
    \hline
      {\bf Parameter} & {\bf Possible values} & {\bf Explanation} \\
    \hline 
             \tcen{AllowSingleFrames} & true & A single input flat field is also allowed\\
                        & false & More than one input flat field is required \\
    \hline
                         & Average & Combined flat field is average of inputs\\
                         & Median  & Combined flat field is median of inputs \\
             StackMethod & MinMax  & Combined flat field is obtained with min-max rejection\\
                         & Ksigma  & Combined flat field is obtained with K-sigma clipping\\
                         & Auto    & Optimal combination of input flat fields \\
    \hline
             MinRejection & {\it int} & No. of lowest rejected values for rejection method \\
    \hline
             MaxRejection & {\it int} & No. of highest rejected values for rejection method \\
    \hline
             KSigmaLow & {\it float} (sigma) & Low threshold for K-sigma clipping method \\
    \hline
             KSigmaHigh & {\it float} (sigma) & High threshold for K-sigma clipping method \\
%    \hline
%             \tcen{ValidateFrames} & true & Run consistency check on raw dark frames \\
%                            & false & Skip consistency check on raw dark frames \\
%    \hline
%             LevelTolerance & {\it float} (sigma) & Threshold for level consistency \\
%             PatternTolerance & {\it float} (sigma) & Threshold for flux pattern consistency \\
    \hline
              \tcen{BiasMethod} & Master & Bias removal with no overscan correction \\
                        & Zmaster & Bias removal with overscan correction \\
    \hline
             \tcen{CleanBadPixel}  & true & Interpolate bad pixels on master sky flat \\
                            & false & No bad pixel correction \\
    \hline
             \tcen{CleanCosmic}    & true & Remove cosmic ray events from each flat field \\
                            & false & No cosmic ray removal \\
    \hline
             CosmicThreshold & {\it float} & Sigmas above level discriminator \\
    \hline
             CosmicRatio & {\it float} & Peak/neighbours discriminator \\
    \hline
             SmoothBoxSize & {\it int} (pixel) & Size of smoothing running box\\
    \hline
             \tcen{SmoothMethod} & Median & Median of values in running box\\
                          & Average & Average of values in running box\\
    \hline
             \tcen{ComputeQC} & true & Compute QC parameters \\
                         & false & Do not compute QC parameters \\
    \hline
    \end{tabular}
    \caption{\it vmimflatsky parameters.}
    \label{tab:CFLATSKY}
  \end{center}
\end{table}

A more complete description of the parameters meaning is also given:

\begin{description}

\item [AllowSingleFrames:]  If this parameter is set, then a master sky
                        flat field is produced also from a single input 
                        sky flat field frame.
                        In that case the \ {\it StackMethod} \ is ignored.

\item [BiasMethod:]     Method for bias removal from the input sky
                        flat field frames.
                        The bias removal procedure is described in some
                        detail in Section \ref{ABIAS}. Possible settings are:

\begin{description}
  \item [Master:]       After master bias subtraction, prescan and
                        overscan regions are trimmed away from the
                        flat field frame.

  \item [Zmaster:]      After master bias subtraction the overscan correction
                        is applied before trimming away the overscan regions.
\end{description}

\item [CleanBadPixel:]  Bad pixel correction on the master sky flat field.
                        If this option is turned on, a bad pixel
                        table should be specified in the input SOF
                        (see Table \ref{IFLATSKY}). The bad pixel
                        correction algorithm is described in Section
                        \ref{sec:ABADPIX}, page \pageref{sec:ABADPIX}.

\item [CleanCosmic:]    Cosmic ray events removal from each input flat field.
                        The cosmic ray rejection algorithm is described 
                        in Section \ref{sec:ACOSMIC}, page \pageref{sec:ACOSMIC}.

\item [ComputeQC:]      If this parameter is set, \ {\it Quality Control}
                        \ (QC) parameters will be computed and written to 
                        the header of the output master sky flat field 
                        and to an 
                        output QC PAF file named \ {\tt qc0000.paf}. 
                        \ This file is not classified as a pipeline recipe 
                        product, as it is an intermediate dataset 
                        that in the standard pipeline operations would 
                        be translated into new entries in the QC log file. 
                        Currently the QC parameters computed by 
                        \ {\it vmimflatsky} \ are:

\begin{description}

\item {\tt QC SKY FLAT FLUX:} Mean value of the 1600x1800 central pixels 
                   of the first sky flat field listed in the input SOF,
                   after bias removal and division by the exposure time.
\item {\tt QC SKY FLAT RMS:} The population standard deviation of the 
                   1600x1800 central pixels of the normalised master 
                   sky flat field.
\item {\tt QC SKY FLAT STRUCT:} The standard deviation 
                   \ {\tt QC SKY FLAT RMS} \ 
                   can be seen as the combination of large scale
                   structure with noise sources. The difference
                   between the master and the master itself shifted by
                   10x10 pixels is computed, and the variance of the
                   1600x1800 central pixels of the result is computed
                   and corrected by a factor 2. This evaluation of
                   other noise sources is then quadratically subtracted
                   from the total standard deviation.

\end{description}

\item [CosmicRatio:]    Critical ratio for reducing the effect of variable
                        background on cosmic rays identification. This 
                        parameter is effective when \ {\it CleanCosmic} 
                        \ is set.

\item [CosmicThreshold:]  Threshold for the selection of cosmic rays
                        candidates. This parameter is effective when 
                        \ {\it CleanCosmic} \ is set.

\item [KSigmaHigh:]  Number of standard deviations above the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

\item [KSigmaLow:]  Number of standard deviations below the median pixel
                    value for rejecting a pixel value
                    when \ {\it StackMethod} \ is set to \ {\it ``Ksigma''}.

\item [MaxRejection:]  Number of highest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.

\item [MinRejection:]  Number of lowest pixel values to be rejected 
                       when \ {\it StackMethod} \ is set to \ {\it ``MinMax''}.

\item [SmoothBoxSize:] Length in pixel of the side of the square smoothing
                       box used in the normalisation of the master flat
                       field.

\item [SmoothMethod:]  The smoothing method used in the normalisation of the
                       master flat field. Possible settings are:

\begin{description}
  \item [Median:] The central pixel within the smoothing running box
                  is replaced with the median of the values of the
                  pixels contained in the box.

  \item [Average:] The central pixel within the smoothing running box
                  is replaced with the average of the values of the
                  pixels contained in the box.

\end{description}

\item [StackMethod:]  Combination method of input sky flat fields for 
                      combined flat field 
                      creation. See Section \ref{ACOMB} for a complete 
                      description of all the combination methods. Possible 
                      settings are:

\begin{description}

  \item [Auto:]     Given the number of input sky flat fields, an optimal 
                    combination method is selected. Currently this is
                    always going to the method \ {\it ``Average''}.

  \item [Average:]  The combined sky flat field is the mean of the 
                    input frames.

  \item [Ksigma:]   The combined sky flat field is the mean of the 
                    input frames, after
                    K-sigma screening of pixel values. The number of sigma 
                    to be applied in the rejection is specified by the 
                    parameters \ {\it KSigmaLow} \ and \ {\it KSigmaHigh}.

  \item [Median:]   The combined sky flat field is the median of the 
                    input frames.

  \item [MinMax:]   The combined sky flat field is the mean of the 
                    input frames, after
                    rejection of minimum and maximum values.
                    The number of values to reject is specified by the 
                    parameters \ {\it MinRejection} \ and \ {\it MaxRejection}.

\end{description}

\end{description}

A description of the algorithms used in this recipe is given in Section
\ref{AFLATSKY}, page \pageref{AFLATSKY}.

